#!@PERL@

# Linda Wharton and Paul Schultz -- Feb 97
# Note that in all the system calls we invoke the bourne shell (sh)
# explicitly, because this perl script is being invoked from a csh.
#
# Modified by Jim Edwards for newlaps Jul 97
#
$LAPSROOT=shift || die "LAPS root directory required\n";

$ENV{LAPS_DATA_ROOT} = shift ;
$ENV{LAPS_DATA_ROOT} = "$LAPSROOT/data" if ! $ENV{LAPS_DATA_ROOT};
$LAPS_DATA_ROOT = $ENV{LAPS_DATA_ROOT};

# Import names of LAPS bigfile depositories.
$FXA_DATA = $ENV{"FXA_DATA"};
$FXA_DATA_BACKUP = $ENV{"FXA_DATA_BACKUP"};

# For local use.
$XFR_HOME="$LAPSROOT/bin";
$FCSTPRD="$LAPS_DATA_ROOT/lapsprd";
$BIGFILE_PATH="Grid/FSL/netCDF/LAPS_Grid/LAPS";
$WFO_FCSTPRD="$FXA_DATA/$BIGFILE_PATH";
$WFO_FCSTPRD_BACKUP="$FXA_DATA_BACKUP/$BIGFILE_PATH";
$TRANS_TBL="$LAPS_DATA_ROOT/static/public_laps2wfo.tbl";
$LAPSTIME="$LAPS_DATA_ROOT/time/systime.dat";
$CDL_PATH="$FXA_DATA/Grid/FSL/CDL";



#Export environment variables for use in xfer_laps.
$ENV{"XFR_HOME"} =   $XFR_HOME;
$ENV{"FCSTPRD"} =    $FCSTPRD;
$ENV{"WFO_FCSTPRD"} =$WFO_FCSTPRD;
$ENV{"TRANS_TBL"} =  $TRANS_TBL;
$ENV{"LAPSTIME"} =   $LAPSTIME;
$ENV{"CDL_PATH"} =   $CDL_PATH;
      

open(LAPSTIME,$LAPSTIME) or die "Can't open $LAPSTIME";
($filetime,$dummy,$utc_hour,$utc_min) = <LAPSTIME>;
close(LAPSTIME);
chomp($filetime); chomp($utc_hour); chomp($utc_min);





$filetime =~ s/ *//;  #fortran write may have added leading spaces
$filetime= $filetime - 315619200;

system "$LAPSROOT/bin/xfer_laps.exe";

$mon++;
($ss,$mm,$hh,$dd,$mon,$yy) = gmtime($filetime);
$mon++;
$yy += 1900;
$filename = sprintf "%4.4d%2.2d%2.2d_%2.2d00", ($yy,$mon,$dd,$hh);

use File::Copy 'cp';

cp("$WFO_FCSTPRD/$filename", "$WFO_FCSTPRD_BACKUP/$filename");

$sys = "$ENV{FXA_HOME}/bin/GridNotify.script Laps $filetime 0";
print "running $sys\n";

system $sys;


if($ENV{FXA_LOCAL_SITE} eq "FSL"){
    print "Copying file $WFO_FCSTPRD/$filename to yarmouth\n";
    $sys = "rcp $WFO_FCSTPRD/$filename yarmouth:$WFO_FCSTPRD";
    print $sys;
    system $sys;
}









