#!/bin/csh      

# This script converts model data into FUA/FSF files 

# Supports composite reflectivity data for the HRRR, and can be more 
# generalized later to other fields/models

setenv LAPS_DATA_ROOT $1

setenv MODEL $2

setenv YYDDDHHMM `perl @prefix@/etc/sched_sys.pl -c 21600`              

#setenv YYDDDHHMM `head -1 $LAPS_DATA_ROOT/time/modelvtime.dat`
setenv YYDDDHHMM 122021200 # for testing

echo "YYDDDHHMM (modelvtime) = $YYDDDHHMM"

setenv NCTEMPLATE $LAPS_DATA_ROOT/template.fsf
#setenv NCTEMPLATE /home/fab/oplapb/template.fsf

# Create FSF template file
#echo "ncgen -o $NCTEMPLATE $LAPS_DATA_ROOT/cdl/fsf.cdl"
#      ncgen -o $NCTEMPLATE $LAPS_DATA_ROOT/cdl/fsf.cdl

echo "NCTEMPLATE is $NCTEMPLATE"
ls -l $NCTEMPLATE

foreach HRRRHH (00 01)

    setenv FCSTTIMEHRRR 0000

    if ($HRRRHH == 00) then
        setenv MMTIMES '00'
        setenv FHH 00          
    else
        setenv MMTIMES '15 30 45 60'
        @ FHH_I = $HRRRHH - 1
        setenv FHH 0$FHH_I
    endif

    foreach FMM ($MMTIMES)

        if ($FMM == 60 || $HRRRHH == 00) then
            setenv FHH $HRRRHH
            setenv FCSTTIME $FHH\00 
        else
            @ FHH_I = $HRRRHH - 1
            setenv FHH 0$FHH_I
            setenv FCSTTIME $FHH$FMM
        endif

        if ($HRRRHH == 00)then
            @ REC_LMR = 1
        else
            @ REC_LMR = ((($FMM / 15) - 1) * 31) + 1
        endif

        @ REC_TSF = $REC_LMR + 18

        echo " "
        echo "Processing forecast time/record $FCSTTIME $REC_LMR"

#       setenv GRIBIN /home/Steve.Albers/public/data/fsl/hrrr/conus/wrftwo_subh/$YYDDDHHMM$HRRRHH\00         
        setenv GRIBIN /public/data/fsl/hrrr/conus/wrftwo_subh/$YYDDDHHMM$HRRRHH\00         

#       setenv NCOUT /home/Steve.Albers/outdir/$YYDDDHHMM$FCSTTIME.fsf
        setenv OUTDIR $LAPS_DATA_ROOT/lapsprd/fsf/$MODEL
        setenv NCOUT $OUTDIR/$YYDDDHHMM$FCSTTIME.fsf

#       Specify stmas_hwt grid for testing
#       setenv NEWGRID "-new_grid lambert:-98.408:35.25:35.25 -105.0:433:3000. 28.0:433.:3000."
        setenv NEWGRID " "                                                                         
        echo "NEWGRID is $NEWGRID"

        echo "wgrib2  $GRIBIN -s -d $REC_LMR         $NEWGRID -netcdf $NCOUT"
              wgrib2  $GRIBIN -s -d $REC_LMR         $NEWGRID -netcdf $NCOUT

        echo "wgrib2  $GRIBIN -s -d $REC_TSF -append $NEWGRID -netcdf $NCOUT"
              wgrib2  $GRIBIN -s -d $REC_TSF -append $NEWGRID -netcdf $NCOUT

        echo "ncrename -v var0_16_196_localleveltype2000,lmr -v TMP_2maboveground,tsf $NCOUT"          
              ncrename -v var0_16_196_localleveltype2000,lmr -v TMP_2maboveground,tsf $NCOUT           
 
#       echo "ncatted -a lmr_fcinv,global,a,s,1 $NCOUT"
#             ncatted -a lmr_fcinv,global,a,s,1 $NCOUT

        echo "ncatted -a lvl_coord,lmr,a,c,"MSL" $NCOUT"
              ncatted -a lvl_coord,lmr,a,c,"MSL" $NCOUT

        echo "ncatted -a LAPS_units,lmr,a,c,"DBZ" $NCOUT"
              ncatted -a LAPS_units,lmr,a,c,"DBZ" $NCOUT

        echo "ncatted -a x_dim,global,a,c,"x" $NCOUT"
              ncatted -a x_dim,global,a,c,"x" $NCOUT

        echo "ncatted -a Nx,global,a,s,1800 $NCOUT"
              ncatted -a Nx,global,a,s,1800 $NCOUT

#       Add dimensions: record = UNLIMITED, z, nav, namelen                   
#       See http://jisao.washington.edu/data/nco/

#       Add record dimension
        echo "ncecat -O -h $NCOUT $NCOUT"       
              ncecat -O -h $NCOUT $NCOUT

#       Change value of time dimension (wipes out the lmr field)
#       setenv STR1 "time = UNLIMITED ; // (1 currently)"
#       setenv STR2 "time = 1 ;"
#       echo "ncdump $NCOUT  | sed -e "s#^.$STR1# $STR2#" | ncgen -o $NCOUT"
#             ncdump $NCOUT  | sed -e "s#^.$STR1# $STR2#" | ncgen -o $NCOUT

#       Rename time dimension to z
        echo "ncrename -d time,z $NCOUT"          
              ncrename -d time,z $NCOUT           

#       Add record dimension
#       echo "ncecat -O -h $NCOUT $NCOUT"       
#             ncecat -O -h $NCOUT $NCOUT

#       Reorder dimensions                       
        echo "ncpdq -a record,z,y,x -O $NCOUT $NCOUT"
              ncpdq -a record,z,y,x -O $NCOUT $NCOUT

#       Append miscellaneous variables from FSF template file
        echo "ncks -A -v lmr_comment,tsf_comment,imax,jmax,kmax,kdim,level,lmr_fcinv $NCTEMPLATE $NCOUT"
              ncks -A -v lmr_comment,tsf_comment,imax,jmax,kmax,kdim,level,lmr_fcinv $NCTEMPLATE $NCOUT

#       echo "ncks -A -v imax $NCIN $NCOUT"
#             ncks -A -v imax $NCIN $NCOUT

#       exit # for testing

#       Rename record dimension to namelen
#       echo "ncrename -d record,namelen $NCOUT"          
#             ncrename -d record,namelen $NCOUT           

#       Change value of namelen dimension
#       setenv STR1 "namelen = UNLIMITED ; // (1 currently)"
#       setenv STR1 "namelen = 1"                            
#       setenv STR2 "namelen = 132"
#       echo "ncdump $NCOUT  | sed -e "s#^.$STR1# $STR2#" | ncgen -o $NCOUT"
#             ncdump $NCOUT  | sed -e "s#^.$STR1# $STR2#" | ncgen -o $NCOUT

#       Add new record dimension
#       echo "ncecat -O -h $NCOUT $NCOUT"       
#             ncecat -O -h $NCOUT $NCOUT

#       Rename record dimension to z
#       echo "ncrename -d record,namelen $NCOUT"          
#             ncrename -d record,namelen $NCOUT           

#       Add record dimension
#       echo "ncecat -O -h $NCOUT $NCOUT"       
#             ncecat -O -h $NCOUT $NCOUT

#       echo "ncpdq -O -h -a time,record $NCOUT $NCOUT"        
#             ncpdq -O -h -a time,record $NCOUT $NCOUT  

#       echo "ncwa -O -h -a record $NCOUT $NCOUT"           
#             ncwa -O -h -a record $NCOUT $NCOUT          

#       echo "wgrib2  $GRIBIN         -nc_table ./hrrr_g2nc.table  -netcdf $NCOUT"
#             wgrib2  $GRIBIN         -nc_table ./hrrr_g2nc.table  -netcdf $NCOUT 

#       exit # for testing

    end

end

echo ""
echo "output..."
ls -l $OUTDIR
