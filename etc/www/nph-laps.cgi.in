#!@PERL@ -T
# nph-laps.cgi (script to display LAPS data)

$DEBUG=0;

# STANDARD PREAMBLE vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
#for security
$ENV{'PATH'} = "/usr/bin:/bin";

#redirect stderr to stdout so we can see err msgs on the web
$|=1;  #force flush of buffers after each print
open (STDERR, ">&STDOUT") || die "can't dup stdout ($!)\n";

use lib "@prefix@/etc/www"; # Set this to your path for 'cgi-lib.pl'
require "cgi-lib.pl";    # supplied in $LAPSINSTALLROOT/etc/www OR /w3/utilities

use lib "@prefix@/etc"; # Set this to your path for 'laps_tools.pm'
require "laps_tools.pm";                 # supplied in $LAPSINSTALLROOT/etc
require "oputil.pm";                     # supplied in $LAPSINSTALLROOT/etc
    
#set up some nice variables
@month=(Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec);
@day=(Sun,Mon,Tue,Wed,Thu,Fri,Sat);

#get directory and URL
use File::Basename;
($basename,$thisDir) = fileparse($0);
#untaint it
$thisDir =~ /([a-zA-Z0-9\.\/\~]*)/;
$thisDir = $1;
my ($basename,$thisURLDir) = fileparse($ENV{'SCRIPT_NAME'} || '.'); 

my $addr2 = pack('C4',split(/\./,$ENV{REMOTE_ADDR}));
my $returnAddress = gethostbyaddr($addr2,2) || $ENV{REMOTE_ADDR} ||
     "(Unknown-Requestor)";

# $web_root is where the '$web_root/domains/[list of domains]/private_data'
# soft links (to each $LAPS_DATA_ROOT) should be set up
$web_root = "/w3/lapb";

# request_root is where the '$request_root/lapsplot/scratch' directory tree
# should be set up
$request_root = "$web_root/request"; # current directory of this script

$DomainDir = "$web_root/domains";
#$ScratchDir = "/scratch/frd/laps/www";
$ScratchDir = "request/lapsplot/scratch";

#change to the proper directory
chdir ("$thisDir") ||
          die "Content-type: text/html\n\nCan't cd to $thisDir: $!\n";

# END OF PREAMBLE ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

#get calling URL
$temp = $ENV{'SCRIPT_NAME'};
#untaint it (the unsafe way!)
$temp =~ /(.*)/;
# check for the right-most slash
$1 =~ m|([^/]*$)|;
$thisURL = $`;
chop $thisURL;
$writeDir = "${thisDir}tmp";

	 
#get time 
$time = time();
($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = gmtime($time);
$mp1=$mon+1;
$thisMonth=$month[$mon];
$dayOfWeek=$day[$wday];

#have this expire in 0 hour, so the form won't keep resetting itself.
use HTTP::Date;
$plusOneHour=time() + 1*3600;
my $stringGMT = time2str($plusOneHour);   # Format as GMT ascii time
$server_protocol = $ENV{'SERVER_PROTOCOL'};
# since this is 'nph-', print out the whole header
print "$server_protocol 200 OK\n" .
    "Content-type: text/html\n" .
      "Expires: $stringGMT\n\n";

#parse the query string
&ReadParse(*input) ;

#clean up old files older than .24 hrs

#useful DEBUGGING info vvvvvvvvvvvvvv
if ($DEBUG == 1) {
    print "<pre>\n";
    print &PrintVariables(%input);

    print "input is $input<br>\n";
    while (($first,$last) = each(%input)) {
	@items = split("\0",$last);
	print " |$first|  ==>  |@items|\n";
    }
    print "<P>\n";
}
#end debugging info vvvvvvvvvvvvvvvvv

print<<"EOI";
<html>
<body background="/icons_laps/LongerLAPS.gif">   
EOI

#opendir DOMAINS, "/w3/laps/domains";
#@filelist = readdir DOMAINS;
#close DOMAINS;
#@filelist = sort @filelist;

@domains = split("\0",$input{'domains'});
$n_domains = @domains;
$out_domains="[" . join(',',@domains) . "]";
$ENV{'domains'} = $out_domains;
$ENV{'n_domains'}= $n_domains;
print "$n_domains domain(s) selected: ";
print "@domains....";

@sources = split("\0",$input{'sources'});
$n_sources = @sources;
$out_sources="[" . join(',',@sources) . "]";
print "$n_sources source(s) selected: ";
print "@sources....";

# Personalize the title
my $beka;
if($returnAddress =~ /137\.75\.10\.102/) {
   $beka = 2;
} elsif ($returnAddress =~ /jetson\.fsl\.noaa\.gov/) {
   $beka = 2;
} elsif ($returnAddress =~ /137\.75\.100\.42/) {
   $beka = 1;
} elsif ($returnAddress =~ /cumulus\.fsl\.noaa\.gov/) {
   $beka = 1;
} else {
   $beka = 0;
}

# Set access level
my $lvl_access;
if($returnAddress =~ /noaa\.gov/) {
   $lvl_access = 2;
} else {
   $lvl_access = 1;
}

if(! -e "/w3/lapb"){ # Being run outside of ESRL/GSD/FAB
   $lvl_access = 2;
}

#print "beka = $returnAddress $beka ";

$default_title="FSL/LAPS Data Display (On-the-fly)";
if(@sources[0] =~ "wrf" || @sources[0] =~ "arw" || @sources[0] =~ "nmm") {
    if($beka == 2){
        $default_title="Beka's @sources[0]";
    } elsif($beka == 1) {
        $default_title="Steve's @sources[0]";
    } else {
        $default_title="@sources[0]";
    }
} else {
    $default_title="FSL/LAPS Data Display (On-the-fly)";
}

print "<head><title>$default_title</title></head>";

@fields = split("\0",$input{'fields'});
$n_fields = @fields;
print "$n_fields field(s) selected: ";
print "@fields....";
$out_fields="[" . join(',',@fields) . "]";
$n_fields_uc = 0;
foreach $field (@fields) {
    if ($field eq uc($field)){
        $n_fields_uc++
    }
}

@pressure_levels = split("\0",$input{'pressure_levels'});
$n_levels = @pressure_levels;
print "$n_levels level(s) selected: ";
print "@pressure_levels....";
$out_levels="[" . join(',',@pressure_levels) . "]";
$ENV{'pressure_levels'} = $out_levels;
$ENV{'n_levels'}= $n_levels;

#$ENV{'file'} = $file;
$ENV{'file_in'} = $file_in;
$density=$input{'density'};
$thickness=$input{'thickness'};
$frames=$input{'frames'};
$delay=$input{'delay'};
#$ENV{'NewZoom'} = $NewZoom;
$a9time=$input{'a9time'};
$forecast_time=$input{'forecast_time'};
$zoom=$input{'zoom'};
$xcen=$input{'xcen'};
$ycen=$input{'ycen'};
$npix=$input{'npix'};
$ENV{'Domain'} = $Domain;
$CenterLon=$input{'CenterLon'};
$ENV{'CenterLon'} = $CenterLon;

$default_title="FSL/LAPS Data Display<br>(Experimental)";
$default_minusHours = 3;
#get time minus $minusHours hours ago as a default starting time
($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = 
    gmtime($time - $default_minusHours*3600);
$mp1=$mon+1;
$file_in =~ s/ /+/g;
$link_prefix="<a href=\"$thisURL/$basename?density=$density&thickness=$thickness&frames=$frames&a9time=$a9time&CenterLon=$CenterLon&pressure_levels=";

#$file = $file_in;
#$domain = $file_in;
$domain = @domains[0];

$err=0;
$montage=0;


my $domain_first;
$domain =~ /(.*)/;
$domain_first = $1;

my $laps_data_root;
$laps_data_root = "$DomainDir/$domain_first/private_data";

#Read desired units
my $domain_nl;
my $nl_var;
my $units;
my @units_array;
if(-e "$laps_data_root/static/lapsplot.nl"){
    $domain_nl = "lapsplot.nl";
    $nl_var="c_units_type";
    @units_array=&laps_tools::get_nl_value($domain_nl,$nl_var,$laps_data_root);
    $units=@units_array[0];
}

#print "unitsarray = @units_array<br>";
#print "units1 = $units<br>";

my $xcen_safe;
$xcen =~ /(.*)/;
$xcen_safe = $1;

my $ycen_safe;
$ycen =~ /(.*)/;
$ycen_safe = $1;

my $npix_safe;
$npix =~ /(.*)/;
$npix_safe = $1;

my $zoom_safe;
$zoom =~ /(.*)/;
$zoom_safe = $1;

my $zoom_lapsplot;

my $density_safe;
$density =~ /(.*)/;
$density_safe = $1;

my $thickness_safe;
$thickness =~ /(.*)/;
$thickness_safe = $1;

my $delay_safe;
$delay =~ /(.*)/;
$delay_safe = $1;

my $frames_safe;
$frames =~ /(.*)/;
$frames_safe = $1;
my $frames_orig = $frames_safe;

my $size_safe;
$size_safe = $thickness_safe;

chomp $a9time;

my $a9time_safe;
$a9time =~ /(.*)/;
$a9time_safe = $1;

my $a9time_orig = $a9time_safe;
my $a9time_offset;

#my $a9time_wgi_safe;
my $wgi_file;
my $wgi_file2;
my $wgi_only = 0;
my $animate = "no";
my $sect = "none";

#print "xcen = $xcen $xcen_safe<br>";

#print "sect/window 1 = $sect $window\n";

#print "domain (first) = $domain_first<br>";
chomp $forecast_time;
print "time = $a9time";

#Default units is set above as read in from the lapsplot.nl namelist
if($domain_first =~ "tw_" || $domain_first =~ "tai" || $domain_first =~ "th" || $domain_first =~ "fmi"){
    $units = "metric";
}

#print "units2 = $units<br>";

# Obtain cycle time 
my $cycle_time;
my @cycle_array;
if ($frames_safe > 1 || $frames_safe eq "auto"){ 
    if(-e "$laps_data_root/static/nest7grid.parms"){
        $domain_nl = "nest7grid.parms";
        $nl_var="laps_cycle_time";
        @cycle_array=&laps_tools::get_nl_value($domain_nl,$nl_var,$laps_data_root);
        $cycle_time=@cycle_array[0];
    }
    $animate = "yes";
}

# Error conditions
if ($n_domains == 0) {
    $err=1;
    print<<"EOI";
<h2>Please select a one or more domains...</h2>
</body></html>
EOI
}

if ($n_sources == 0) {
    $err=1;
    print<<"EOI";
<h2>Please select one or more sources...</h2>
EOI
}

if ($n_fields == 0) {
    $err=1;
    print<<"EOI";
<h2>Please select one or more fields...</h2>
EOI
}

if ($n_levels == 0) {
    $err=1;
    print<<"EOI";
<h2>Please select one or more levels...</h2>
EOI
}

if ($frames_safe > 1 && $a9time_safe eq "") {
    $err=1;
    print<<"EOI";
<h2>Please select a valid end time for multi-frame image...</h2>
</body></html>
EOI
}

my $n_sources_fields = 0;
foreach $source (@sources) {
    if("$source" =~ "mm5" || "$source" =~ "eta" || "$source" =~ "sfm" || "$source" =~ "wrf" || "$source" =~ "arw" || "$source" =~ "nmm" || "$source" =~ "WRF" || "$source" =~ "bkgnd" || "$source" =~ "spin" || "$source" =~ "hot" ){
        $n_sources_fields++
    }
    if($source eq "bkgnd" || $source eq "analysis" || $source eq "balanced" ){
        $n_sources_fields++
    }
}

#print "<h2>n_fields_uc = $n_fields_uc</h2>";

if($n_fields_uc > 1 && $n_sources_fields > 0 && (@fields[0] != "CLDCLV" || @fields[1] != "REFLCT") ){ # exception for cloud/radar combo
    print "<h2>Error: only 1 upper case field should be selected (image montages not yet supported)...</h2>";
    $err=1;
}else{
    if($n_domains == 1 && $n_fields_uc == 1 && $n_sources_fields > 1){
        print "<h2>Montage multiple sources (under construction)...</h2>";
#       $err=1;
        $montage=1;
    }
    if($n_domains == 1 && $n_fields_uc >  1 && $n_sources_fields == 1){
        print "<h2>Montage multiple fields (under construction)...</h2>";
#       $err=1;
        $montage=1;
    }
    if($n_sources_fields > 0 && $n_fields_uc == 1 && $n_levels > 1){
        print "<h2>Montage multiple levels (under construction)...</h2>";
#       $err=1;
        $montage=1;
    }
}

# Montage for multiple domains
if($n_domains > 1 && $n_sources_fields == 1 && $n_fields_uc > 0){
    $montage=1;
}

# Generate product
if($err == 0) {
# Write a lapsplot.in file
# $logFile = "$thisDir/lapsplot/lapsplot.in";
  $logFile = "$web_root/$ScratchDir/lapsplot.in_$$";
  open(LAPSPLOT,">$logFile") ||
        die "Content-type: text/html\n\nCan't open $logFile: $!\n";

# Determine if one of the sources is a forecast, if so obtain $a9time from the $systime
  $fcst=0;
  foreach $source (@sources) {
    if("$source" =~ "mm5" || "$source" =~ "eta" || "$source" =~ "sfm" || "$source" =~ "wrf" || "$source" =~ "arw" || "$source" =~ "nmm" || "$source" =~ "WRF" || "$source" =~ "bkgnd" || "$source" =~ "spin" || "$source" =~ "hot" ){
        $fcst=1;
    }
  }

  if($frames_safe eq "auto"){
    $frames_safe = 1;
    if(length($forecast_time) > 8){

#       If length is 9 or 10 we can assume $forecast_time is really initial time and
#       then subtract initial time from valid time to yield forecast time

        my $i4time_valid = &laps_tools::a9time_to_i4time($a9time_orig);
        my $i4time_initial = &laps_tools::a9time_to_i4time($forecast_time);
        my $i4time_fcst = $i4time_valid - $i4time_initial;
#       print " forecast seconds = $i4time_fcst";
#       print " auto cycle_time = $cycle_time";
        $frames_safe = ($i4time_fcst / $cycle_time) + 1;
#       print " auto frames_safe = $frames_safe";
        $frames = $frames_safe;
        print " auto frames = $frames";
    }
  }

  while($frames_safe > 0){

    if($a9time_safe ne ""){

#     Subtract from the a9time based on the frame count 
#     print "a9time orig = $a9time_orig ";

#     Convert a9time to i4time
      my ($i4time_orig);
      $i4time_orig = &laps_tools::a9time_to_i4time($a9time_orig);
#     print "i4time_orig is $i4time_orig ";

#     Offset the i4time
      my ($i4time_offset,$i4time_new);
      $i4time_offset = ($frames_safe - 1) * $cycle_time;
      $i4time_new = $i4time_orig - $i4time_offset;
#     print "i4time new = $i4time_new ";

#     Convert offset i4time to a9time
      $a9time_safe = &laps_tools::i4time_to_a9time($i4time_new);

      if(($frames_safe == $frames_orig) && ($a9time_safe != $a9time_orig)){ 
          print " a9time start = $a9time_safe\n";
      }

    }

#   Signal new time after the first frame
#   print " nt frames = $frames";
#   print " nt frames_safe = $frames_safe";

    if($frames != $frames_safe){ 
        printf LAPSPLOT "nt\n";
    }

#   Print a9time (either with a value or blank)
    if($fcst == 1 && $a9time eq ""){
#       print "fcst = $fcst";

#       Get the latest a9time from the systime.dat
#       my($jjj,$hh,$dd,$MMM,$yyyy,$time,$mm,$yy,$rtime,$yy,$hhmm);
        if(open(LAPSTIME,"$laps_data_root/time/systime.dat")){
            my @lapstime = <LAPSTIME>;
#           print "lapstime = @lapstime";
            close(LAPSTIME);
            $lapstime[1] =~ /(\d\d\d\d\d\d\d\d\d)/;
            $a9time_fcst = $1;
#           print "a9time_fcst = $a9time_fcst";
            printf LAPSPLOT "$a9time_fcst\n";
        }

    }else{

#       If this is blank it means latest time
        printf LAPSPLOT "$a9time_safe\n";
#       printf LAPSPLOT " \n";

    }

    my $overlay = 0;
#   $sect = "none";
    my $sounding;

#   Print the field

    my $obs_sfc = "none";
    my $obs_sfc_qc = 0;
    my $hhmm;

    if(length($forecast_time) > 8){

#       If length is 9 or 10 we can assume $forecast_time is really initial time and
#       then subtract initial time from valid time to yield forecast time

        my $i4time_valid = &laps_tools::a9time_to_i4time($a9time_safe);
        my $i4time_initial = &laps_tools::a9time_to_i4time($forecast_time);
        my $i4time_fcst = $i4time_valid - $i4time_initial;
#       print " forecast seconds = $i4time_fcst";
        my $fcsthh = int($i4time_fcst / 3600);
        $fcsthh = "0".$fcsthh while(length($fcsthh)<2);     
        my $fcstmm = int( ($i4time_fcst-$fcsthh*3600) / 60);
        $fcstmm = "0".$fcstmm while(length($fcstmm)<2);     
        $hhmm = "$fcsthh"."$fcstmm";
        print " derived hhmm = $hhmm";

    }else{ # If length is 4 or 5
        $hhmm = $forecast_time;
        print "$hhmm";

    }

#   Correct zoom_safe if it is invalid
#   if($zoom_safe < 1.00 && @pressure_levels[0] != "xsect"){$zoom_safe = 1.00;}

    my $a9time_wgi = $a9time_safe;
    $a9time_wgi =~ /(\d\d\d\d\d\d\d\d\d)/;
    $a9time_wgi = $1;

    my $dot = ".";

    foreach $domain (@domains) {

#     my $domain_safe;
#     $domain =~ /(.*)/;
#     $domain_safe = $1;

#     if($domain ne $domain_first){
#         printf LAPSPLOT "fc\n"; 
#         printf LAPSPLOT "$DomainDir/$domain/private_data\n"; 
#     }

      foreach $source (@sources) {
        $sounding = 0;

        if ("$source" eq "what-got-in" ) {                                                                  # What-got-in stuff
            if ($n_sources == 1) {
                $wgi_only = 1;
            }

            if($a9time_wgi eq ""){

                print "<h2>What-got-in option selected...</h2>";

#               Get the latest a9time from the systime.dat

#               my($jjj,$hh,$dd,$MMM,$yyyy,$time,$mm,$yy,$rtime,$yy,$hhmm);
                if(open(LAPSTIME,"$laps_data_root/time/systime.dat")){
                    my @lapstime = <LAPSTIME>;
                    close(LAPSTIME);
                    $lapstime[1] =~ /(\d\d\d\d\d\d\d\d\d)/;
                    $a9time_wgi = $1;
                }

            }else{
                print "<h2>What-got-in option selected at $a9time_wgi...</h2>";

            }

            if ($out_levels =~ "[0-1,3-9]" || $out_levels =~ "xsect") {                                                    # Primarily 3D fields
#             print "<h2>Debug: What-got-in options selected for 3D fields $out_levels $out_fields</h2>";
              if ($out_fields =~ "wind" || $out_fields =~ "WIND" || $out_fields eq "WIND_U" || $out_fields eq "wind_u" || $out_fields eq "WIND_V" || $out_fields eq "wind_v") {                                                    # Wind
#               print "<h2>Debug: Match found for $out_fields</h2>";
                $wgi_file = "$laps_data_root/log/wind\.wgi\.$a9time_wgi";
                $wgi_file2 = "$laps_data_root/log/wind3d\.wgi\.$a9time_wgi";
                if( -e "$wgi_file"){
                    print "<h2>What-got-in wind analysis for $a9time_wgi...</h2>";
                    print "<pre>";
                    system("cat $wgi_file");
                    print "</pre>";
                }elsif( -e "$wgi_file2"){
                    print "<h2>What-got-in wind analysis for $a9time_wgi...</h2>";
                    print "<pre>";
                    system("cat $wgi_file2");
                    print "</pre>";
                }else{
                    print "<h2>What-got-in wind info N/A for $a9time_wgi...</h2>";
                }
              }

              if ($out_fields =~ "temp" || $out_fields =~ "TEMP") {                                                    # Temp
                $wgi_file = "$laps_data_root/log/temp\.wgi\.$a9time_wgi";
                if( -e "$wgi_file"){
                    print "<h2>What-got-in temp analysis for $a9time_wgi...</h2>";
                    print "<pre>";
                    system("cat $wgi_file");
                    print "</pre>";
                }else{
                    print "<h2>What-got-in temp info N/A for $a9time_wgi...</h2>";
                }
              }

              if ($out_fields =~ "rh" || $out_fields =~ "RH" || $out_fields =~ "sh" || $out_fields =~ "SH" || $out_fields =~ "mr" || $out_fields =~ "MR" || $out_fields =~ "dewpoint" || $out_fields =~ "DEWPOINT") {          # Humidity
                $wgi_file  = "$laps_data_root/log/lq3driver\.wgi\.$a9time_wgi";
                $wgi_file2 = "$laps_data_root/log/hum3d\.wgi\.$a9time_wgi";
                if( -e "$wgi_file"){
                    print "<h2>What-got-in humidity analysis for $a9time_wgi...</h2>";
                    print "<pre>";
                    system("cat $wgi_file");
                    print "</pre>";
                }elsif( -e "$wgi_file2"){
                    print "<h2>What-got-in humidity analysis for $a9time_wgi...</h2>";
                    print "<pre>";
                    system("cat $wgi_file2");
                    print "</pre>";
                }else{
                    print "<h2>What-got-in humidity info N/A for $a9time_wgi...</h2>";
                }
              }

            }

            if ($out_fields =~ "cld_" || $out_fields =~ "CLD_" || $out_fields =~ "ref" || $out_fields =~ "REF" || $out_fields =~ "sat_" || $out_fields =~ "SAT_") {    # Cloud fields
              $wgi_file = "$laps_data_root/log/cloud\.wgi\.$a9time_wgi";
              if( -e "$wgi_file"){
                  print "<h2>What-got-in cloud analysis for $a9time_wgi...</h2>";
                  print "<pre>";
                  system("cat $wgi_file");
                  print "</pre>";
              }else{
                  print "<h2>What-got-in cloud info N/A for $a9time_wgi...</h2>";
              }
            }

            if ($out_levels =~ "sfc") {                                                                                # Surface
                $wgi_file = "$laps_data_root/log/sfc\.wgi\.$a9time_wgi";
                if( -e "$wgi_file"){
                    print "<h2>What-got-in sfc analysis for $a9time_wgi...</h2>";
                    print "<pre>";
                    system("cat $wgi_file");
                    print "</pre>";
                }else{
                    print "<h2>What-got-in sfc info N/A for $a9time_wgi...</h2>";
                }
            }

        }elsif ("$source" eq "DIFF" ) { 
            if($n_fields_uc > 0){
                print "<h2>Warning: DIFF should be used only with lower case fields...</h2>";

                if($out_levels =~ "xsect"){
                    printf LAPSPLOT "dfi\n"; 
                }else{
                    printf LAPSPLOT "dii\n"; 
                }

            } elsif ($n_domains > 1 && $montage == 0) {
                if ($n_sources_fields == 1 && $n_fields == 1 && $n_levels == 1){ 
                    print "<h2>Note: DIFF is for multiple domains $domain $domain_first</h2>"; 
                    if($domain ne $domain_first){
                        if($out_levels =~ "xsect"){
                            printf LAPSPLOT "dfi\n"; 
                        }else{
                            printf LAPSPLOT "dii\n"; 
                        }
                    }
                }else{
                    print "<h2>Warning: DIFF should be used only with a single domain...</h2>"; 
                }

            } else {

                if($out_levels =~ "xsect"){
                    printf LAPSPLOT "dfi\n"; 
                }else{
                    printf LAPSPLOT "dii\n"; 
                }

            }

        }elsif ("$source" eq "diff" ) {

            if($n_fields_uc > 0){
                print "<h2>Warning: diff should be used only with lower case fields...</h2>";

                if($out_levels =~ "xsect"){
                    printf LAPSPLOT "df\n"; 
                }else{
                    printf LAPSPLOT "di\n"; 
                }

            } elsif ($n_domains > 1 && $montage == 0) {
                if ($n_sources_fields == 1 && $n_fields == 1 && $n_levels == 1){ 
                    print "<h2>Note: diff is for multiple domains $domain $domain_first</h2>"; 
                    if($domain ne $domain_first){
                        if($out_levels =~ "xsect"){
                            printf LAPSPLOT "df\n"; 
                        }else{
                            printf LAPSPLOT "di\n"; 
                        }
                    }
                }else{
                    print "<h2>Warning: diff should be used only with a single domain...</h2>"; 
                }

            } else {

                if($out_levels =~ "xsect"){
                    printf LAPSPLOT "df\n"; 
                }else{
                    printf LAPSPLOT "di\n"; 
                }

            }

        }else{ # other source

            foreach $field (@fields) {

               foreach $level (@pressure_levels) {

                  if("$level" eq "sndg" && "$source" =~ "obs"){
                      print "<h2>Error: $source cannot be selected with sndg...</h2>";
                  }

                  if ("$level" eq "xsect" && $n_levels > 1){
                      print "<h2>Error: xsect cannot be combined with other levels...</h2>";
                  }

                  if ("$level" eq "sndg" && $n_levels > 1){
                      print "<h2>Error: sndg cannot be combined with other levels...</h2>";
                  }

                  if($overlay == 0){
                      if("$level" eq "xsect"){
                          $sect = "xsect";
                          printf LAPSPLOT "xz\n";
                          printf LAPSPLOT "$density_safe,$thickness_safe\n";
                          printf LAPSPLOT "$zoom_safe\n";
                          printf LAPSPLOT "$xcen_safe,$ycen_safe\n";
                      }elsif("$level" eq "sndg"){
                          $sect = "sndg";
                          printf LAPSPLOT "s\n";
                          printf LAPSPLOT "$xcen_safe\n";
                          printf LAPSPLOT "$ycen_safe\n";
                      }else{
                          $sect = "hsect";
                          printf LAPSPLOT "hz\n";
                          if($zoom_safe < 1.00){$zoom_safe = 1.00;}

#                         $zoom_lapsplot = $zoom_safe * ( $density_safe**2 );
#                         printf LAPSPLOT "$zoom_safe,$density_safe\n";

                          $zoom_lapsplot = $zoom_safe * ( $npix/885. );

                          printf LAPSPLOT "$zoom_lapsplot,$density_safe,$thickness_safe,$xcen_safe,$ycen_safe,$zoom_safe,$size_safe\n";

#                         printf LAPSPLOT "fc\n"; 
#                         printf LAPSPLOT "$DomainDir/$domain/private_data\n"; 

                      }
                  }

                  if($sect eq "hsect"){
#                     if($montage == 1 && $domain ne $domain_first && $field eq uc($field)){ 
                      if(    $montage == 1 && $domain ne $domain_first && $source eq $sources[0] && $field eq $fields[0]){ # montage multiple domains
                          print "multiple domains field/field(0) is $field $fields[0]<br>\n";
                          printf LAPSPLOT "fcf\n"; 
                          $animate = "yes";
                      }elsif($montage == 1 && $domain eq $domain_first && $source ne $sources[0] && $field eq $fields[0]){ # montage multiple sources
                          print "multiple sources field/field(0) is $field $fields[0]<br>\n";
                          printf LAPSPLOT "fcf\n"; 
                          $animate = "yes";
                      }elsif($montage == 1 && $domain eq $domain_first && $source eq $sources[0] && $field ne $fields[0] && $field eq uc($field)){ # montage multiple fields
                          print "multiple fields field/field(0) is $field $fields[0]<br>\n";
                          printf LAPSPLOT "fcf\n"; 
                          $animate = "yes";
                      }elsif($montage == 1 && $domain eq $domain_first && $source eq $sources[0] && $field eq $fields[0] && $level ne $pressure_levels[0]){ # montage multiple levels
                          print "multiple levels level/pressure_level(0) is $level $pressure_levels[0]<br>\n";
                          printf LAPSPLOT "fcf\n"; 
                          $animate = "yes";
                      }else{
                          printf LAPSPLOT "fc\n"; 
                      }
                      printf LAPSPLOT "$DomainDir/$domain/private_data\n"; 
                  }

#                 print "overlay/level/sect is $overlay $level $sect<br>\n";

                  $overlay = $overlay + 1;
                  $sounding = $sounding + 1;

                  if("$source" =~ "mm5" || "$source" =~ "eta" || "$source" =~ "sfm" || "$source" =~ "wrf" || "$source" =~ "arw" || "$source" =~ "nmm" || "$source" =~ "WRF" || "$source" =~ "spin" || "$source" =~ "hot"){
                      if("$level" eq "sfc/2d"){                # fsf sfc forecast
                          if   ("$field" eq "p_msl" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "slp\n"; 

                          }elsif("$field" eq "P_MSL" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "slpi\n"; 
      
                          }elsif("$field" eq "stn_p" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "psf\n"; 
      
                          }elsif("$field" eq "red_p" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "p\n"; 
      
                          }elsif("$field" eq "TEMP" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "tsfi\n"; 
                              if($units eq "english"){
                                  printf LAPSPLOT "f\n"; 
                              }else{
                                  printf LAPSPLOT "c\n"; 
                              }
      
                          }elsif("$field" eq "temp" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "tsf\n"; 
                              if($units eq "english"){
                                  printf LAPSPLOT "f\n"; 
                              }else{
                                  printf LAPSPLOT "c\n"; 
                              }
      
                          }elsif("$field" eq "SFCT" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "tgdi\n"; 
                              if($units eq "english"){
                                  printf LAPSPLOT "f\n"; 
                              }else{
                                  printf LAPSPLOT "c\n"; 
                              }
      
                          }elsif("$field" eq "sfct" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "tgd\n"; 
                              if($units eq "english"){
                                  printf LAPSPLOT "f\n"; 
                              }else{
                                  printf LAPSPLOT "c\n"; 
                              }

                          }elsif("$field" eq "DEWPOINT" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "dsfi\n"; 
                              if($units eq "english"){
                                  printf LAPSPLOT "f\n"; 
                              }else{
                                  printf LAPSPLOT "c\n"; 
                              }
      
                          }elsif("$field" eq "dewpoint" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "dsf\n"; 
                              if($units eq "english"){
                                  printf LAPSPLOT "f\n"; 
                              }else{
                                  printf LAPSPLOT "c\n"; 
                              }
      
                          }elsif("$field" eq "MR" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "msfi\n"; 
      
                          }elsif("$field" eq "mr" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "msf\n"; 
      
                          }elsif("$field" eq "wind_u" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "usf\n"; 
      
                          }elsif("$field" eq "wind_v" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "vsf\n"; 
      
                          }elsif("$field" eq "rh" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "rh\n"; 
      
                          }elsif("$field" eq "RH" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "rhi\n"; 
      
                          }elsif("$field" eq "prcp_h2o" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "tpw\n"; 
      
                          }elsif("$field" eq "PRCP_H2O" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "tpwi\n"; 
      
                          }elsif("$field" eq "wind" ) { 
                              printf LAPSPLOT "wr\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "vc\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
      
                          }elsif("$field" eq "WIND_SPD" ) { 
                              printf LAPSPLOT "wri\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "sp\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";

                          }elsif("$field" eq "wind_spd" ) { 
                              printf LAPSPLOT "wr\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "sp\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";

                          }elsif("$field" eq "thetae" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "the\n"; 
      
                          }elsif("$field" eq "THETAE" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "thei\n"; 
      
                          }elsif("$field" eq "CAPE" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "pbei\n"; 

                          }elsif("$field" eq "cape" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "pbe\n"; 
      
                          }elsif("$field" eq "CIN" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "nbei\n"; 

                          }elsif("$field" eq "cin" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "nbe\n"; 

                          }elsif("$field" eq "HELICITY" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "lhei\n"; 

                          }elsif("$field" eq "helicity" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "lhe\n"; 

                         }elsif("$field" eq "WTBLB0" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "tw0i\n"; 
 
                         }elsif("$field" eq "wtblb0" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "tw0\n"; 
 
                         }elsif("$field" eq "REF_MAX" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "lmri\n"; 

                          }elsif("$field" eq "ref_max" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "lmr\n"; 

                          }elsif("$field" eq "REFLCT" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "llri\n"; 

                          }elsif("$field" eq "reflct" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "llr\n"; 

                          }elsif("$field" eq "FIREWX" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "fwxi\n"; 

                          }elsif("$field" eq "firewx" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "fwx\n"; 

                          }elsif("$field" eq "FIRE_FBG" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "fwii\n"; 

                          }elsif("$field" eq "fire_fbg" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "fwi\n"; 

                          }elsif("$field" eq "VENT_INDX" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "vnti\n"; 

                          }elsif("$field" eq "vent_indx" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "vnt\n"; 

                          }elsif("$field" eq "UMFLUX" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "umfi\n"; 

                          }elsif("$field" eq "umflux" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "umf\n"; 

                          }elsif("$field" eq "HAINES" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "hahi\n"; 

                          }elsif("$field" eq "haines" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "hah\n"; 

                          }elsif("$field" eq "CLD_CVR" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "lcvi\n"; 

                          }elsif("$field" eq "cld_cvr" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "lcv\n"; 

                          }elsif("$field" eq "SNOW_1HR") { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "s01i\n"; 

                          }elsif("$field" eq "snow_1hr") { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "s01\n"; 

                          }elsif("$field" eq "PCP_INC") { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "r01i\n"; 

                          }elsif("$field" eq "pcp_inc") { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "r01\n"; 

                          }elsif("$field" eq "SNOW_STO") { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "stoi\n"; 

                          }elsif("$field" eq "snow_sto") { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "sto\n"; 

                          }elsif("$field" eq "PCP_STO") { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "rtoi\n"; 

                          }elsif("$field" eq "pcp_sto") { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "rto\n"; 

                          }elsif("$field" eq "SAT_11U" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "lwoi\n"; 

                          }elsif("$field" eq "sat_11u" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "lwo\n"; 

                          }elsif("$field" eq "VIS_ALB" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "swoi\n"; 

                          }elsif("$field" eq "vis_alb" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "swo\n"; 
      
                          }elsif("$field" eq "le_flux" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "lhf\n"; 
      
                          }elsif("$field" eq "LE_FLUX" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "lhfi\n"; 
      
                          }elsif("$field" eq "se_flux" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "shf\n"; 
      
                          }elsif("$field" eq "SE_FLUX" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "shfi\n"; 
      
                          }elsif("$field" eq "LONG_WAVE" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "lwoi\n"; 
      
                          }elsif("$field" eq "SHRT_WAVE" ) { 
                              printf LAPSPLOT "bs\n"; 
                              printf LAPSPLOT "fsf\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "swoi\n"; 

                          }elsif("$field" eq "HT" ){ 
                              printf LAPSPLOT "gg\n"; 
                              printf LAPSPLOT "tni\n"; 

                          }elsif("$field" eq "ht" ){ 
                              printf LAPSPLOT "gg\n"; 
                              printf LAPSPLOT "tn\n"; 

                          }else{
                              print "$source $level $field not yet available<br>\n"; 
      
                          } # if field

                      }elsif("$level" eq "xsect"){ # fua xsect forecast
                          if   ("$field" eq "temp" ){ 
                              printf LAPSPLOT "t\n";  
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "TEMP" ){ 
                              printf LAPSPLOT "ti\n";  
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "HT" ){ 
                              printf LAPSPLOT "hti\n";  
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "ht" ){ 
                              printf LAPSPLOT "ht\n";  
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "theta" ){ 
                              printf LAPSPLOT "pt\n";  
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "THETA" ){ 
                              printf LAPSPLOT "pti\n";  
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "REFLCT" ){ 
                              printf LAPSPLOT "ri\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "reflct" ){ 
                              printf LAPSPLOT "rf\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "wind_omega" ) { 
                              printf LAPSPLOT "om\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "WIND_OMEGA" ) { 
                              printf LAPSPLOT "omi\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "wind_div" ) { 
                              printf LAPSPLOT "dv\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "WIND_DIV" ) { 
                              printf LAPSPLOT "dvi\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "wind_vort" ) { 
                              printf LAPSPLOT "vo\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "WIND_VORT" ) { 
                              printf LAPSPLOT "voi\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "wind_pvort" ) { 
                              printf LAPSPLOT "pv\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "WIND_PVORT" ) { 
                              printf LAPSPLOT "pvi\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "rh" ){ 
                              printf LAPSPLOT "rh\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "RH" ){ 
                              printf LAPSPLOT "rhi\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "sh" ){ 
                              printf LAPSPLOT "sh\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "SH" ){ 
                              printf LAPSPLOT "shi\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "mr" ){ 
                              printf LAPSPLOT "sh\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "MR" ){ 
                              printf LAPSPLOT "shi\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "wind" ){ 
                              printf LAPSPLOT "vc\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "wind_u" ){ 
                              printf LAPSPLOT "u\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "WIND_U" ){ 
                              printf LAPSPLOT "ui\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "wind_v" ){ 
                              printf LAPSPLOT "v\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "WIND_V" ){ 
                              printf LAPSPLOT "vi\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "wind_spd" ){ 
                              printf LAPSPLOT "sp\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "WIND_SPD" ){ 
                              printf LAPSPLOT "spi\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "cld_liq" ){ 
                              printf LAPSPLOT "ls\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "CLD_LIQ" ){ 
                              printf LAPSPLOT "lsi\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "cld_ice" ){ 
                              printf LAPSPLOT "ci\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "CLD_ICE" ){ 
                              printf LAPSPLOT "cii\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "pcp_rai" ){ 
                              printf LAPSPLOT "rn\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "PCP_RAI" ){ 
                              printf LAPSPLOT "rni\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "pcp_sno" ){ 
                              printf LAPSPLOT "sn\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "PCP_SNO" ){ 
                              printf LAPSPLOT "sni\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "pcp_ice" ){ 
                              printf LAPSPLOT "ic\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }elsif("$field" eq "PCP_ICE" ){ 
                              printf LAPSPLOT "ici\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }else{ 
                              print "$source $level $field not available\n"; 
                          }
      
                      }elsif("$level" eq "sndg"){ # FUA Sounding
                          if($sounding == 1){
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n"; 
                              printf LAPSPLOT "$hhmm\n";
                          }
      
                      }else{                       # fua hsect level forecast
                          if   ("$field" eq "ht" ) { 
                              printf LAPSPLOT "hr\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
      
                          }elsif("$field" eq "HT" ) { 
                              printf LAPSPLOT "hri\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
      
                          }elsif("$field" eq "temp" ) { 
                              printf LAPSPLOT "tr\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 

                          }elsif("$field" eq "TEMP" ) { 
                              printf LAPSPLOT "tri\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
      
                          }elsif("$field" eq "rh" ) { 
                              printf LAPSPLOT "fr\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "r\n"; 
                              printf LAPSPLOT "-132.\n"; 
      
                          }elsif("$field" eq "RH" ) { 
                              printf LAPSPLOT "fri\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "r\n"; 
                              printf LAPSPLOT "-132.\n"; 

                          }elsif("$field" eq "sh" ) { 
                              printf LAPSPLOT "fr\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "q\n"; 
      
                          }elsif("$field" eq "SH" ) { 
                              printf LAPSPLOT "fri\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "q\n"; 

                          }elsif("$field" eq "mr" ) { 
                              printf LAPSPLOT "fr\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "q\n"; 
      
                          }elsif("$field" eq "MR" ) { 
                              printf LAPSPLOT "fri\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "q\n"; 
      
                          }elsif("$field" eq "pcp_typ" ) { 
                              printf LAPSPLOT "py\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";

                          }elsif("$field" eq "pcp_cnc" ) { # Precip concentration = rain and snow overlay
                              printf LAPSPLOT "rn\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "sn\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";

                          }elsif("$field" eq "pcp_rai" ) { 
                              printf LAPSPLOT "rn\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
      
                          }elsif("$field" eq "pcp_sno" ) { 
                              printf LAPSPLOT "sn\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";

                          }elsif("$field" eq "pcp_ice" ) { 
                              printf LAPSPLOT "pi\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "f\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";

                          }elsif("$field" eq "wind" ) { 
                              printf LAPSPLOT "wr\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "vc\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";
      
                          }elsif("$field" eq "WIND_SPD" ) { 
                              printf LAPSPLOT "wri\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "sp\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";

                          }elsif("$field" eq "wind_spd" ) { 
                              printf LAPSPLOT "wr\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "sp\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";

                          }elsif("$field" eq "wind_u") { 
                              printf LAPSPLOT "wr\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "u\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";

                          }elsif("$field" eq "wind_v") { 
                              printf LAPSPLOT "wr\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "v\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";

                          }elsif("$field" eq "WIND_U") { 
                              printf LAPSPLOT "wri\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "u\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";

                          }elsif("$field" eq "WIND_V") { 
                              printf LAPSPLOT "wri\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "v\n"; 
                              printf LAPSPLOT "$source\n";
                              printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_div" ) { 
                        printf LAPSPLOT "wr\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "dv\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_DIV" ) { 
                        printf LAPSPLOT "wri\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "dv\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_vort" ) { 
                        printf LAPSPLOT "wr\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "vo\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_VORT" ) { 
                        printf LAPSPLOT "wri\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "vo\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_pvort" ) { 
                        printf LAPSPLOT "wr\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "pv\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_PVORT" ) { 
                        printf LAPSPLOT "wri\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "pv\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "vort_adv" ) { 
                        printf LAPSPLOT "wr\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "va\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_omega" ) { 
                        printf LAPSPLOT "fo\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_OMEGA" ) { 
                        printf LAPSPLOT "foi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "cld_liq" ) { 
                        printf LAPSPLOT "ls\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "f\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "CLD_LIQ" ) { 
                        printf LAPSPLOT "lsi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "f\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "cld_ice" ) { 
                        printf LAPSPLOT "ci\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "f\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "CLD_ICE" ) { 
                        printf LAPSPLOT "cii\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "f\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "reflct" ) { 
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "f\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "REFLCT" ) { 
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "rfi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "f\n"; 
                        printf LAPSPLOT "$source\n";
                        printf LAPSPLOT "$hhmm\n";

		    }else{
                        print "$source $level mb $field not yet available<br>\n"; 

	            } # if field

                } # if level
           
            }elsif("$source" =~ "bkgnd"){          # lga/lgb
                if("$level" eq "sfc/2d"){          
                    if   ("$field" eq "p_msl" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "slp\n"; 

                    }elsif("$field" eq "red_p" ) { 
                         printf LAPSPLOT "bs\n"; 
                         printf LAPSPLOT "lgb\n"; 
                         printf LAPSPLOT "$hhmm\n";
                         printf LAPSPLOT "p\n"; 

                    }elsif("$field" eq "TEMP" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "tsfi\n"; 
                        if($units eq "english"){
                            printf LAPSPLOT "f\n"; 
                        }else{
                            printf LAPSPLOT "c\n"; 
                        }

                    }elsif("$field" eq "temp" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "tsf\n"; 
                        if($units eq "english"){
                            printf LAPSPLOT "f\n"; 
                        }else{
                            printf LAPSPLOT "c\n"; 
                        }

                    }elsif("$field" eq "DEWPOINT" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "dsfi\n"; 
                        if($units eq "english"){
                            printf LAPSPLOT "f\n"; 
                        }else{
                            printf LAPSPLOT "c\n"; 
                        }

                    }elsif("$field" eq "dewpoint" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "dsf\n"; 
                        if($units eq "english"){
                            printf LAPSPLOT "f\n"; 
                        }else{
                            printf LAPSPLOT "c\n"; 
                        }

                    }elsif("$field" eq "SFCT" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "tgdi\n"; 
                        if($units eq "english"){
                            printf LAPSPLOT "f\n"; 
                        }else{
                            printf LAPSPLOT "c\n"; 
                        }
      
                    }elsif("$field" eq "sfct" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "tgd\n"; 
                        if($units eq "english"){
                            printf LAPSPLOT "f\n"; 
                        }else{
                            printf LAPSPLOT "c\n"; 
                        }

                    }elsif("$field" eq "wind" ) { # lgb
                        printf LAPSPLOT "wb\n"; 
                        printf LAPSPLOT "0\n"; 
                        printf LAPSPLOT "vc\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_SPD" ) { 
                        printf LAPSPLOT "wbi\n"; 
                        printf LAPSPLOT "0\n"; 
                        printf LAPSPLOT "sp\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_spd" ) { 
                        printf LAPSPLOT "wb\n"; 
                        printf LAPSPLOT "0\n"; 
                        printf LAPSPLOT "sp\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_div" ) { 
                        printf LAPSPLOT "wb\n"; 
                        printf LAPSPLOT "0\n"; 
                        printf LAPSPLOT "dv\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_DIV" ) { 
                        printf LAPSPLOT "wbi\n"; 
                        printf LAPSPLOT "0\n"; 
                        printf LAPSPLOT "dv\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_u" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "usf\n"; 

                    }elsif("$field" eq "WIND_U" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "usfi\n"; 

                    }elsif("$field" eq "wind_v" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "vsf\n"; 

                    }elsif("$field" eq "WIND_V" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "vsfi\n"; 

                    }elsif("$field" eq "stn_p" ) { 
                        printf LAPSPLOT "bs\n"; 
                        printf LAPSPLOT "lgb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "psf\n"; 

                    }elsif("$field" eq "VIS_ALB" ) { 
                        printf LAPSPLOT "gg\n"; 
                        printf LAPSPLOT "ali\n"; 

                    }elsif("$field" eq "vis_alb" ) { 
                        printf LAPSPLOT "gg\n"; 
                        printf LAPSPLOT "al\n"; 

		    }else{
                        print "$source $level $field not yet available<br>\n"; 

	            } # if field

                }elsif("$level" eq "xsect"){ # lga xsect background
                    if   ("$field" eq "wind" ){ 
                        printf LAPSPLOT "vc\n";  
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "WIND_SPD" ){ 
                        printf LAPSPLOT "spi\n";  
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "wind_spd" ){ 
                        printf LAPSPLOT "sp\n";  
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "WIND_OMEGA" ) { 
                        printf LAPSPLOT "omi\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "wind_omega" ) { 
                        printf LAPSPLOT "om\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "wind_div" ) { 
                        printf LAPSPLOT "dv\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "WIND_DIV" ) { 
                        printf LAPSPLOT "dvi\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "wind_vort" ) { 
                        printf LAPSPLOT "vo\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "WIND_VORT" ) { 
                        printf LAPSPLOT "voi\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "wind_pvort" ) { 
                        printf LAPSPLOT "pv\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "WIND_PVORT" ) { 
                        printf LAPSPLOT "pvi\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "vort_adv" ) { 
                        printf LAPSPLOT "va\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "rh" ) { 
                        printf LAPSPLOT "rh\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "RH" ) { 
                        printf LAPSPLOT "rhi\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "sh" ) { 
                        printf LAPSPLOT "sh\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "SH" ) { 
                        printf LAPSPLOT "shi\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "mr" ) { 
                        printf LAPSPLOT "sh\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "MR" ) { 
                        printf LAPSPLOT "shi\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "temp" ) { 
                        printf LAPSPLOT "t\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "TEMP" ) { 
                        printf LAPSPLOT "ti\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "ht" ) { 
                        printf LAPSPLOT "ht\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "HT" ) { 
                        printf LAPSPLOT "hti\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "theta" ) { 
                        printf LAPSPLOT "pt\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "THETA" ) { 
                        printf LAPSPLOT "pti\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "wind_u" ) { 
                        printf LAPSPLOT "u\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "WIND_U" ) { 
                        printf LAPSPLOT "ui\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "wind_v" ) { 
                        printf LAPSPLOT "v\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }elsif("$field" eq "WIND_V" ) { 
                        printf LAPSPLOT "vi\n"; 
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }else{ 
                        print "$source $level $field not available\n"; 
                    }

                }elsif("$level" eq "sndg"){ # LGA Sounding
                    if($sounding == 1){
                        printf LAPSPLOT "b\n"; 
                        printf LAPSPLOT "$hhmm\n";
                    }

                }else{                       # Background lga - 3D levels
                    if   ("$field" eq "ht" ) { 
                        printf LAPSPLOT "hb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 

                    }elsif("$field" eq "HT" ) { 
                        printf LAPSPLOT "hbi\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 

                    }elsif("$field" eq "temp" ) { 
                        printf LAPSPLOT "tb\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 

                    }elsif("$field" eq "TEMP" ) { 
                        printf LAPSPLOT "tbi\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 

                    }elsif("$field" eq "rh" ) { 
                        printf LAPSPLOT "br\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "r\n"; 
                        printf LAPSPLOT "-132.\n"; 

                    }elsif("$field" eq "RH" ) { 
                        printf LAPSPLOT "bri\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "r\n"; 
                        printf LAPSPLOT "-132.\n"; 

                    }elsif("$field" eq "dewpoint" ) { 
                        printf LAPSPLOT "br\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "d\n"; 
                        printf LAPSPLOT "-132.\n"; 

                    }elsif("$field" eq "DEWPOINT" ) { 
                        printf LAPSPLOT "bri\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "d\n"; 
                        printf LAPSPLOT "-132.\n"; 

                    }elsif("$field" eq "sh" ) { 
                        printf LAPSPLOT "br\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "q\n"; 

                    }elsif("$field" eq "SH" ) { 
                        printf LAPSPLOT "bri\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "q\n"; 

                    }elsif("$field" eq "mr" ) { 
                        printf LAPSPLOT "br\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "q\n"; 

                    }elsif("$field" eq "MR" ) { 
                        printf LAPSPLOT "bri\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "q\n"; 

                    }elsif("$field" eq "wind" ) { 
                        printf LAPSPLOT "wb\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "vc\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_SPD" ) { 
                        printf LAPSPLOT "wbi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "sp\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_spd" ) { 
                        printf LAPSPLOT "wb\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "sp\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_div" ) { 
                        printf LAPSPLOT "wb\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "dv\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_DIV" ) { 
                        printf LAPSPLOT "wbi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "dv\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_vort" ) { 
                        printf LAPSPLOT "wb\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "vo\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_VORT" ) { 
                        printf LAPSPLOT "wbi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "vo\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_pvort" ) { 
                        printf LAPSPLOT "wb\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "pv\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_PVORT" ) { 
                        printf LAPSPLOT "wbi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "pv\n"; 
                        printf LAPSPLOT "$hhmm\n";
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "vort_adv" ) { 
                        printf LAPSPLOT "wb\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "va\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_U" ) { 
                        printf LAPSPLOT "wbi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "u\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_u" ) { 
                        printf LAPSPLOT "wb\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "u\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_V" ) { 
                        printf LAPSPLOT "wbi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "v\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_v" ) { 
                        printf LAPSPLOT "wb\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "v\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "wind_omega" ) { 
                        printf LAPSPLOT "lo\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "WIND_OMEGA" ) { 
                        printf LAPSPLOT "loi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "$hhmm\n";

		    }else{
                        print "$source $level mb $field not yet available<br>\n"; 

	            } # if field

                } # if level
           
            }elsif("$source" eq "obs"){
                if("$level" eq "sfc/2d"){                                                            # Sfc Obs
#                   print "$field $obs_sfc \n";

                    if($obs_sfc eq "none" || $field eq "SFCT" || $field eq "sfct" || $field eq "stn_p" || $field eq "alt_p" 
                    || $field eq "p_prime"  || $field eq "P_PRIME"  
                    || $field eq "red_p" || $field eq "ref_max" || $field eq "REF_MAX" 
                    || $field eq "snow_cvr" || $field eq "SNOW_CVR" 
                    || $field eq "cld_cvr" || $field eq "CLD_CVR" 
#                   || $field eq "umflux" || $field eq "UMFLUX" 
                                                                           ){                        # Overlay always for these

                        if("$field" eq "vsblty" || "$field" eq "VSBLTY") { 
                            printf LAPSPLOT "ov\n"; 
                            printf LAPSPLOT " \n"; 
                            $obs_sfc = "vsblty";    # This is set to prevent station model overlays

                        }elsif("$field" =~ "pcp_" || "$field" =~ "PCP_") { 
                            printf LAPSPLOT "op\n"; 
                            printf LAPSPLOT " \n"; 
                            $obs_sfc = "pcp_inc";   # This is set to prevent station model overlays

                        }elsif("$field" =~ "umflux" || "$field" =~ "UMFLUX") { 
                            printf LAPSPLOT "op\n"; 
                            printf LAPSPLOT " \n"; 
                            $obs_sfc = "pcp_inc";   # This is set to prevent station model overlays

                        }elsif("$field" eq "snow_sto" ) { 
                            printf LAPSPLOT "op\n"; 
                            printf LAPSPLOT " \n"; 
                            $obs_sfc = "snow_sto";   # This is set to prevent station model overlays

                        }elsif("$field" eq "CLD_CVR" ) { 
                            printf LAPSPLOT "ov\n"; 
                            printf LAPSPLOT " \n"; 
                            $obs_sfc = "vsblty";   # This is set to prevent station model overlays

                        }elsif("$field" eq "cld_cvr" ) { 
                            printf LAPSPLOT "ov\n"; 
                            printf LAPSPLOT " \n"; 
                            $obs_sfc = "vsblty";   # This is set to prevent station model overlays

#                       }elsif("$field" =~ "SAT_" ) { 
#                           printf LAPSPLOT "ov\n"; 
#                           printf LAPSPLOT " \n"; 
#                           $obs_sfc = "vsblty";   # This is set to prevent station model overlays

#                       }elsif("$field" =~ "sat_" ) { 
#                           printf LAPSPLOT "ov\n"; 
#                           printf LAPSPLOT " \n"; 
#                           $obs_sfc = "vsblty";   # This is set to prevent station model overlays

                        }elsif("$field" eq "wind_u" || "$field" eq "WIND_U") { 
                            printf LAPSPLOT "ow\n"; 
                            printf LAPSPLOT " \n"; 

                        }elsif("$field" eq "wind_v" || "$field" eq "WIND_V") { 
                            printf LAPSPLOT "ow\n"; 
                            printf LAPSPLOT " \n"; 

                        }elsif("$field" =~ "wind" || "$field" =~ "WIND") { 
                            printf LAPSPLOT "ow\n"; 
                            printf LAPSPLOT " \n"; 

                        }elsif("$field" eq "vis_alb"){ 
                            printf LAPSPLOT "lv\n"; 
                            printf LAPSPLOT "$hhmm\n"; 
                            printf LAPSPLOT "1\n"; 
                            printf LAPSPLOT "ALB\n";
#                           printf LAPSPLOT "n\n";   

                        }elsif("$field" eq "VIS_ALB"){ 
                            printf LAPSPLOT "lv\n"; 
                            printf LAPSPLOT "$hhmm\n"; 
                            printf LAPSPLOT "-1\n"; 
                            printf LAPSPLOT "ALB\n";
#                           printf LAPSPLOT "n\n";   

                       }elsif("$field" eq "sat_11u" ) { 
                           printf LAPSPLOT "lv\n"; 
                           printf LAPSPLOT "$hhmm\n"; 
                           printf LAPSPLOT "4\n"; 
                           printf LAPSPLOT "S8A\n"; 
                           $obs_sfc = "vsblty";   # This is set to prevent station model overlays

                       }elsif("$field" eq "SAT_11U" ) { 
                           printf LAPSPLOT "lv\n"; 
                           printf LAPSPLOT "$hhmm\n"; 
                           printf LAPSPLOT "-4\n"; 
                           printf LAPSPLOT "S8A\n"; 
#                          $obs_sfc = "vsblty";   # This is set to prevent station model overlays

                       }elsif("$field" eq "sat_12u" ) { 
                           printf LAPSPLOT "lv\n"; 
                           printf LAPSPLOT "$hhmm\n"; 
                           printf LAPSPLOT "5\n"; 
                           printf LAPSPLOT "S8A\n"; 
                           $obs_sfc = "vsblty";   # This is set to prevent station model overlays

                       }elsif("$field" eq "SAT_12U" ) { 
                           printf LAPSPLOT "lv\n"; 
                           printf LAPSPLOT "$hhmm\n"; 
                           printf LAPSPLOT "-5\n"; 
                           printf LAPSPLOT "S8A\n"; 
#                          $obs_sfc = "vsblty";   # This is set to prevent station model overlays

                       }elsif("$field" eq "sat_wv" ) { 
                           printf LAPSPLOT "lv\n"; 
                           printf LAPSPLOT "$hhmm\n"; 
                           printf LAPSPLOT "3\n"; 
                           printf LAPSPLOT "S4A\n"; 
                           $obs_sfc = "vsblty";   # This is set to prevent station model overlays

                       }elsif("$field" eq "SAT_WV" ) { 
                           printf LAPSPLOT "lv\n"; 
                           printf LAPSPLOT "$hhmm\n"; 
                           printf LAPSPLOT "-3\n"; 
                           printf LAPSPLOT "S4A\n"; 
#                          $obs_sfc = "vsblty";   # This is set to prevent station model overlays

                        }elsif("$field" eq "sat_39u" ) { 
                            printf LAPSPLOT "lv\n"; 
                            printf LAPSPLOT "$hhmm\n"; 
                            printf LAPSPLOT "2\n"; 
                            printf LAPSPLOT "S3A\n"; 
                            $obs_sfc = "vsblty";   # This is set to prevent station model overlays

                        }elsif("$field" eq "SAT_39U" ) { 
                            printf LAPSPLOT "lv\n"; 
                            printf LAPSPLOT "$hhmm\n"; 
                            printf LAPSPLOT "-2\n"; 
                            printf LAPSPLOT "S3A\n"; 
                            $obs_sfc = "vsblty";   # This is set to prevent station model overlays

                        }elsif("$field" eq "ref_max" ) { 
                            printf LAPSPLOT "ra\n"; 
                            printf LAPSPLOT "mr\n"; 
                            printf LAPSPLOT " \n"; 
#                           $obs_sfc = "ref_max";

                        }elsif("$field" eq "REF_MAX" ) { 
                            printf LAPSPLOT "ra\n"; 
                            printf LAPSPLOT "mri\n"; 
                            printf LAPSPLOT " \n"; 
#                           $obs_sfc = "REF_MAX";

                        }elsif("$field" eq "reflct" ) { 
                            printf LAPSPLOT "ra\n"; 
                            printf LAPSPLOT "lr\n"; 
                            printf LAPSPLOT " \n"; 
#                           $obs_sfc = "ref_max";

                        }elsif("$field" eq "REFLCT" ) { 
                            printf LAPSPLOT "ra\n"; 
                            printf LAPSPLOT "lri\n"; 
                            printf LAPSPLOT " \n"; 
#                           $obs_sfc = "REF_MAX";

                        }elsif("$field" eq "SNOW_CVR"){
                            printf LAPSPLOT "csci\n";
#                           printf LAPSPLOT " \n"; 

                        }elsif("$field" eq "snow_cvr"){ 
                            printf LAPSPLOT "csc\n"; 
#                           printf LAPSPLOT " \n"; 

                        }elsif("$field" eq "sfct" || "$field" eq "SFCT"){ 
                            printf LAPSPLOT "og\n"; 
                            printf LAPSPLOT " \n"; 

                        }elsif("$field" eq "SHRT_WAVE"){ 
                            printf LAPSPLOT "og\n"; 
                            printf LAPSPLOT " \n"; 

                        }elsif("$field" eq "prcp_h2o" || "$field" eq "PRCP_H2O"){ 
                            printf LAPSPLOT "wv\n"; 

                        }elsif($units eq "english"){
                            printf LAPSPLOT "of\n"; 
                            if("$field" eq "stn_p" ) { 
                                printf LAPSPLOT "stn\n"; 
                            }elsif("$field" eq "red_p"){
                                printf LAPSPLOT "alt\n"; 
                            }else{
                                printf LAPSPLOT "msl\n"; 
                                $obs_sfc = "p_msl";
                            }
                        }else{ # metric units
                            printf LAPSPLOT "oc\n"; 
                            if("$field" eq "stn_p" ) { 
                                printf LAPSPLOT "stn\n"; 
                            }elsif("$field" eq "red_p"){
                                printf LAPSPLOT "alt\n"; 
                            }else{
                                printf LAPSPLOT "msl\n"; 
                                $obs_sfc = "p_msl";
                            }
                        }
                    } # $obs_sfc 

                }elsif("$level" eq "xsect"){                                                           # Xsect Obs (radar)
                    if("$field" eq "REFLCT" ) { 
                        printf LAPSPLOT "rv\n"; 
                        if("$hhmm" =~ "v"){
                            printf LAPSPLOT "$hhmm\n"; 
		        }else{
                            printf LAPSPLOT "vrz\n"; 
		        }
                    }

                }else{                                                                                 # Obs Aloft
                    if(("$field" eq "temp" || "$field" eq "TEMP") && $lvl_access == 2) { 
                        printf LAPSPLOT "to\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "y\n"; 

                    }elsif("$field" eq "dewpoint" || "$field" eq "DEWPOINT") { 
                        printf LAPSPLOT "ho\n"; 
                        printf LAPSPLOT "$level\n"; 

                    }elsif("$field" eq "sh" || "$field" eq "SH") { 
                        printf LAPSPLOT "qo\n"; 
                        printf LAPSPLOT "$level\n"; 

                    }elsif("$field" eq "mr" || "$field" eq "MR") { 
                        printf LAPSPLOT "qo\n"; 
                        printf LAPSPLOT "$level\n"; 

                    }elsif("$field" eq "wind" && $lvl_access == 2) { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "ob\n"; 
                        printf LAPSPLOT "0\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "r\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "y\n"; 

                    }elsif(("$field" eq "wind_u" || "$field" eq "WIND_U") && $lvl_access == 2) { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "ob\n"; 
                        printf LAPSPLOT "0\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "r\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "y\n"; 

                    }elsif(("$field" eq "wind_v" || "$field" eq "WIND_V") && $lvl_access == 2) { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "ob\n"; 
                        printf LAPSPLOT "0\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "r\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "y\n"; 

                    }elsif(("$field" eq "wind_spd" || "$field" eq "WIND_SPD") && $lvl_access == 2) { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "ob\n"; 
                        printf LAPSPLOT "0\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "r\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "y\n"; 

                    }elsif("$field" eq "reflct" ) { 
                        printf LAPSPLOT "rv\n"; 
                        if("$hhmm" =~ "v"){
                            printf LAPSPLOT "$hhmm\n"; 
		        }else{
                            printf LAPSPLOT "v01\n"; 
		        }
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "$level\n"; 

                    }elsif("$field" eq "REFLCT" ) { 
                        printf LAPSPLOT "rv\n"; 
                        if("$hhmm" =~ "v"){
                            printf LAPSPLOT "$hhmm\n"; 
		        }else{
                            printf LAPSPLOT "v01\n"; 
		        }
                        printf LAPSPLOT "rfi\n"; 
                        printf LAPSPLOT "$level\n"; 

		    }else{
                        print "$source $level mb $field not available $lvl_access<br>\n"; 

	            } # if field

                } # if level
           
            }elsif("$source" eq "obs_qc"){
                if("$level" eq "sfc/2d"){
                    if($obs_sfc_qc == 0){
                        if("$field" eq "sfct" || "$field" eq "SFCT"){
                            printf LAPSPLOT "qg\n"; 
                            printf LAPSPLOT " \n"; 

                        }elsif($units eq "english"){ 
                            printf LAPSPLOT "qf\n"; 
                            if("$field" eq "stn_p" ) { 
                                printf LAPSPLOT "stn\n"; 
                            }else{
                                printf LAPSPLOT "msl\n"; 
                            }
                        }else{
                            printf LAPSPLOT "qc\n"; 
                            if("$field" eq "stn_p" ) { 
                                printf LAPSPLOT "stn\n"; 
                            }else{
                                printf LAPSPLOT "msl\n"; 
                            }
                        }
                        $obs_sfc_qc = 1;
                    }

                }else{                                                                                 # QC'd Obs Aloft
                    if("$field" eq "temp" ) { 
                        print "$source $level mb $field not available<br>\n"; 

                    }elsif("$field" eq "wind" ) { 
                        print "$source $level mb $field not available<br>\n"; 

                    }elsif("$field" eq "reflct" ) { 
                        printf LAPSPLOT "rv\n"; 
                        printf LAPSPLOT "vrz\n"; 
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "$level\n"; 

                    }elsif("$field" eq "REFLCT" ) { 
                        printf LAPSPLOT "rv\n"; 
                        printf LAPSPLOT "vrz\n"; 
                        printf LAPSPLOT "rfi\n"; 
                        printf LAPSPLOT "$level\n"; 

		    }else{
                        print "$source $level mb $field not available<br>\n"; 

	            } # if field

                } # if level
           
            }elsif("$source" eq "analysis"){

                if("$level" eq "sfc/2d"){            # Surface analyses
                    if("$field" eq "CLD_CVR"){ 
                        printf LAPSPLOT "cg\n";  
                        printf LAPSPLOT "0\n"; 

                    }elsif("$field" eq "CLD_TOP" ){ 
                        printf LAPSPLOT "cti\n"; 

                    }elsif("$field" eq "cld_top" ){ 
                        printf LAPSPLOT "ct\n"; 

                    }elsif("$field" eq "CLD_BASE" ){ 
                        printf LAPSPLOT "cbi\n"; 

                    }elsif("$field" eq "cld_base" ){ 
                        printf LAPSPLOT "cb\n"; 

                    }elsif("$field" eq "cld_ceil" ){ 
                        printf LAPSPLOT "cc\n"; 

                    }elsif("$field" eq "cld_type" ){ 
                        printf LAPSPLOT "cy\n"; 
                        printf LAPSPLOT "0\n"; 

                    }elsif("$field" eq "HT" ){ 
                        printf LAPSPLOT "gg\n"; 
                        printf LAPSPLOT "tni\n"; 

                    }elsif("$field" eq "ht" ){ 
                        printf LAPSPLOT "gg\n"; 
                        printf LAPSPLOT "tn\n"; 

#                   }elsif("$field" eq "GG" ){ 
#                       printf LAPSPLOT "gg\n"; 
#                       $string_lapsplot="$hhmm"."i";
#                       printf LAPSPLOT "$string_lapsplot\n";

                    }elsif("$field" eq "GG" ){ 
                        printf LAPSPLOT "ggi\n"; 
                        $string_lapsplot="$hhmm";
                        printf LAPSPLOT "$string_lapsplot\n";

                    }elsif("$field" eq "gg" ){ 
                        printf LAPSPLOT "gg\n"; 
                        printf LAPSPLOT "$hhmm\n";

                    }elsif("$field" eq "sfct"){     # LSX 
                        if($units eq "metric"){
                            printf LAPSPLOT "gc\n"; 
                        }else{
                            printf LAPSPLOT "gf\n"; 
                        }

                    }elsif("$field" eq "SFCT"){     # LSX 
                        if($units eq "metric"){
                            printf LAPSPLOT "gci\n"; 
                        }else{
                            printf LAPSPLOT "gfi\n"; 
                        }

                    }elsif("$field" eq "temp"){     # LSX
                        if($units eq "metric"){
                            printf LAPSPLOT "tc\n"; 
                        }else{
                            printf LAPSPLOT "tf\n"; 
                        }

                    }elsif("$field" eq "TEMP"){     # LSX
                        if($units eq "metric"){
                            printf LAPSPLOT "tci\n"; 
                        }else{
                            printf LAPSPLOT "tfi\n"; 
                        }

                    }elsif("$field" eq "dewpoint"){ 
                        if($units eq "metric"){
                            printf LAPSPLOT "dc\n"; 
                        }else{
                            printf LAPSPLOT "df\n"; 
                        }

                    }elsif("$field" eq "DEWPOINT"){ 
                        if($units eq "metric"){
                            printf LAPSPLOT "dci\n"; 
                        }else{
                            printf LAPSPLOT "dfi\n"; 
                        }
                    }
                    elsif("$field" eq "RH"){ 
                        printf LAPSPLOT "hui\n"; }
                    elsif("$field" eq "rh"){ 
                        printf LAPSPLOT "hu\n"; }
                    elsif("$field" eq "SH"){ 
                        printf LAPSPLOT "mri\n"; }
                    elsif("$field" eq "sh"){ 
                        printf LAPSPLOT "mr\n"; }
                    elsif("$field" eq "MR"){ 
                        printf LAPSPLOT "mri\n"; }
                    elsif("$field" eq "mr"){ 
                        printf LAPSPLOT "mr\n"; }
                    elsif("$field" eq "wind")
                        { printf LAPSPLOT "ws\n"; }
                    elsif("$field" eq "WIND_U")
                        { printf LAPSPLOT "ui\n"; }
                    elsif("$field" eq "wind_u")
                        { printf LAPSPLOT "u\n"; }
                    elsif("$field" eq "WIND_V")
                        { printf LAPSPLOT "vi\n"; }
                    elsif("$field" eq "wind_v")
                        { printf LAPSPLOT "v\n"; }
                    elsif("$field" eq "WIND_SPD")
                        { printf LAPSPLOT "spi\n"; }
                    elsif("$field" eq "wind_spd")
                        { printf LAPSPLOT "sp\n"; }
                    elsif("$field" eq "WIND_DIV")
                        { printf LAPSPLOT "dvi\n"; }
                    elsif("$field" eq "wind_div")
                        { printf LAPSPLOT "dv\n"; }
                    elsif("$field" eq "MCONV")
                        { printf LAPSPLOT "mci\n"; }
                    elsif("$field" eq "mconv")
                        { printf LAPSPLOT "mc\n"; }
                    elsif("$field" eq "WIND_VORT")
                        { printf LAPSPLOT "voi\n"; }
                    elsif("$field" eq "wind_vort")
                        { printf LAPSPLOT "vo\n"; }
                    elsif("$field" eq "p_msl") 
                        { printf LAPSPLOT "pm\n"; }
                    elsif("$field" eq "red_p") 
                        { printf LAPSPLOT "p\n"; }
                    elsif("$field" eq "stn_p") 
                        { printf LAPSPLOT "ps\n"; }
                    elsif("$field" eq "alt_p") 
                        { printf LAPSPLOT "al\n"; }
                    elsif("$field" eq "p_prime") 
                        { printf LAPSPLOT "pp\n"; }
                    elsif("$field" eq "P_PRIME") 
                        { printf LAPSPLOT "ppi\n"; }
                    elsif("$field" eq "THETA") 
                        { printf LAPSPLOT "thi\n"; }
                    elsif("$field" eq "theta") 
                        { printf LAPSPLOT "th\n"; }
                    elsif("$field" eq "THETAE") 
                        { printf LAPSPLOT "tei\n"; }
                    elsif("$field" eq "thetae") 
                        { printf LAPSPLOT "te\n"; }
                    elsif("$field" eq "CAPE") 
                        { printf LAPSPLOT "pei\n"; }
                    elsif("$field" eq "cape") 
                        { printf LAPSPLOT "pe\n"; }
                    elsif("$field" eq "CIN") 
                        { printf LAPSPLOT "nei\n"; }
                    elsif("$field" eq "cin") 
                        { printf LAPSPLOT "ne\n"; }
                    elsif("$field" eq "HELICITY") 
                        { printf LAPSPLOT "hei\n"; }
                    elsif("$field" eq "helicity") 
                        { printf LAPSPLOT "he\n"; }
                    elsif("$field" eq "UMFLUX") 
                        { printf LAPSPLOT "umi\n"; }
                    elsif("$field" eq "umflux") 
                        { printf LAPSPLOT "um\n"; }
                    elsif("$field" eq "WTBLB0") 
                        { printf LAPSPLOT "si\n"; 
                          printf LAPSPLOT "wb0\n"; }
                    elsif("$field" eq "wtblb0") 
                        { printf LAPSPLOT "s\n"; 
                          printf LAPSPLOT "wb0\n"; }
                    elsif("$field" eq "VSBLTY") 
                        { printf LAPSPLOT "vsi\n"; }
                    elsif("$field" eq "vsblty") 
                        { printf LAPSPLOT "vs\n"; }
                    elsif("$field" eq "HEATINDEX") 
                        { printf LAPSPLOT "hii\n"; }
                    elsif("$field" eq "heatindex") 
                        { printf LAPSPLOT "hi\n"; }
                    elsif("$field" eq "FIRE_FBG"){ 
                        printf LAPSPLOT "lfi\n"; 
                        printf LAPSPLOT "fwi\n";}
                    elsif("$field" eq "fire_fbg"){ 
                        printf LAPSPLOT "lf\n"; 
                        printf LAPSPLOT "fwi\n";}
                    elsif("$field" eq "FIREWX"){ 
                        printf LAPSPLOT "fwi\n";}
                    elsif("$field" eq "firewx"){ 
                        printf LAPSPLOT "fw\n";}
                    elsif("$field" eq "VENT_INDX"){ 
                        printf LAPSPLOT "lfi\n"; 
                        printf LAPSPLOT "vnt\n";}
                    elsif("$field" eq "vent_indx"){ 
                        printf LAPSPLOT "lf\n"; 
                        printf LAPSPLOT "vnt\n";}
                    elsif("$field" eq "HAINES"){ 
                        printf LAPSPLOT "lfi\n"; 
                        printf LAPSPLOT "hah\n";}
                    elsif("$field" eq "haines"){ 
                        printf LAPSPLOT "lf\n"; 
                        printf LAPSPLOT "hah\n";}
                    elsif("$field" eq "vis_alb"){ 
                        printf LAPSPLOT "lc\n"; 
                        printf LAPSPLOT "alb\n";} 
                    elsif("$field" eq "VIS_ALB"){ 
                        printf LAPSPLOT "lci\n"; 
                        printf LAPSPLOT "alb\n";} 
                    elsif("$field" eq "SAT_11U"){ 
                        printf LAPSPLOT "lci\n"; 
                        printf LAPSPLOT "s8a\n";} 
                    elsif("$field" eq "sat_11u"){ 
                        printf LAPSPLOT "lc\n"; 
                        printf LAPSPLOT "s8a\n";} 
                    elsif("$field" eq "SAT_12U"){ 
                        printf LAPSPLOT "lv\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "-5\n"; 
                        printf LAPSPLOT "SCA\n";
#                       printf LAPSPLOT "n\n";   
                                                }
                    elsif("$field" eq "sat_12u"){ 
                        printf LAPSPLOT "lv\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "5\n"; 
                        printf LAPSPLOT "SCA\n";
#                       printf LAPSPLOT "n\n";   
                                               }
                    elsif("$field" eq "SAT_WV"){ 
                        printf LAPSPLOT "lv\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "-3\n"; 
                        printf LAPSPLOT "S4A\n";
#                       printf LAPSPLOT "n\n";   
                                               }
                    elsif("$field" eq "sat_wv"){ 
                        printf LAPSPLOT "lv\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "3\n"; 
                        printf LAPSPLOT "S4A\n";
#                       printf LAPSPLOT "n\n";   
                                                }
                    elsif("$field" eq "SAT_39U"){ 
                        printf LAPSPLOT "lci\n"; 
                        printf LAPSPLOT "s3a\n";} 
                    elsif("$field" eq "SAT_D39"){ 
                        printf LAPSPLOT "lci\n"; 
                        printf LAPSPLOT "d39\n";} 
                    elsif("$field" eq "sat_d39"){ 
                        printf LAPSPLOT "lc\n"; 
                        printf LAPSPLOT "d39\n";} 
                    elsif("$field" eq "cld_cvr"){ 
                        printf LAPSPLOT "cv\n"; 
                        printf LAPSPLOT "0\n"; }
                    elsif("$field" eq "REF_MAX"){ 
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "mri\n"; }
                    elsif("$field" eq "ref_max"){ 
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "mr\n"; }
                    elsif("$field" eq "pcp_typ"){ 
                        printf LAPSPLOT "tp\n"; 
                        printf LAPSPLOT "-1\n"; 
                        printf LAPSPLOT "a\n"; }
                    elsif("$field" eq "PCP_INC"){ 
                        printf LAPSPLOT "pai\n"; 
                        printf LAPSPLOT "1\n"; }
                    elsif("$field" eq "pcp_inc"){ 
                        printf LAPSPLOT "pa\n"; 
                        printf LAPSPLOT "1\n"; }
                    elsif("$field" eq "PCP_STO"){ 
                        printf LAPSPLOT "pai\n"; 
                        printf LAPSPLOT "-99\n"; }
                    elsif("$field" eq "pcp_sto"){ 
                        printf LAPSPLOT "pa\n"; 
                        printf LAPSPLOT "-99\n"; }
                    elsif("$field" eq "prcp_h2o"){ 
                        printf LAPSPLOT "pw\n";} 
                    elsif("$field" eq "PRCP_H2O"){ 
                        printf LAPSPLOT "pwi\n";} 
                    elsif("$field" eq "SNOW_1HR"){ 
                        printf LAPSPLOT "sai\n"; 
                        printf LAPSPLOT "1\n"; }
                    elsif("$field" eq "snow_1hr"){ 
                        printf LAPSPLOT "sa\n"; 
                        printf LAPSPLOT "1\n"; }
                    elsif("$field" eq "SNOW_STO"){ 
                        printf LAPSPLOT "sai\n"; 
                        printf LAPSPLOT "-99\n"; }
                    elsif("$field" eq "snow_sto"){ 
                        printf LAPSPLOT "sa\n"; 
                        printf LAPSPLOT "-99\n"; }
                    elsif("$field" eq "REFLCT"){ 
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "lri\n"; }
                    elsif("$field" eq "reflct"){ 
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "lr\n"; }
                    elsif("$field" eq "SNOW_CVR"){ 
                        printf LAPSPLOT "sci\n";} 
                    elsif("$field" eq "snow_cvr"){ 
                        printf LAPSPLOT "sc\n"; }
                    elsif("$field" eq "LAND_FRAC"){ 
                        printf LAPSPLOT "gg\n";  
                        printf LAPSPLOT "lfi\n"; }
                    elsif("$field" eq "land_frac"){ 
                        printf LAPSPLOT "gg\n";  
                        printf LAPSPLOT "lf\n"; }
                    else 
                        { print "$source $level $field not available\n"; }

                }elsif("$level" eq "soil1"){ # soil1
                    if("$field" eq "RH"){ 
                        printf LAPSPLOT "smi\n";   
                        printf LAPSPLOT "1\n"; }  
                    elsif("$field" eq "rh"){ 
                        printf LAPSPLOT "sm\n";  
                        printf LAPSPLOT "1\n"; }  
                    else 
                        { print "$source $level $field not available\n"; }

                }elsif("$level" eq "soil2"){ # soil2
                    if("$field" eq "RH"){ 
                        printf LAPSPLOT "smi\n";   
                        printf LAPSPLOT "2\n"; }  
                    elsif("$field" eq "rh"){ 
                        printf LAPSPLOT "sm\n";  
                        printf LAPSPLOT "2\n"; }  
                    else 
                        { print "$source $level $field not available\n"; }

                }elsif("$level" eq "soil3"){ # soil3
                    if("$field" eq "RH"){ 
                        printf LAPSPLOT "smi\n";   
                        printf LAPSPLOT "3\n"; }  
                    elsif("$field" eq "rh"){ 
                        printf LAPSPLOT "sm\n";  
                        printf LAPSPLOT "3\n"; }  
                    else 
                        { print "$source $level $field not available\n"; }

                }elsif("$level" eq "xsect"){ # xsect analysis
                    if   ("$field" eq "temp" ){ 
                        printf LAPSPLOT "t\n";  
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "TEMP" ){ 
                        printf LAPSPLOT "ti\n";  
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "HT" ){ 
                        printf LAPSPLOT "hti\n";  
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "ht" ){ 
                        printf LAPSPLOT "ht\n";  
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "theta" ){ 
                        printf LAPSPLOT "pt\n";  
                        printf LAPSPLOT "a\n";  
                    }elsif("$field" eq "THETA" ){ 
                        printf LAPSPLOT "pti\n";  
                        printf LAPSPLOT "a\n";  
                    }elsif("$field" eq "thetae" ){ 
                        printf LAPSPLOT "ts\n";  
                    }elsif("$field" eq "THETAE" ){ 
                        printf LAPSPLOT "tsi\n";  
                    }elsif("$field" eq "CLD_CVR" ){ 
                        printf LAPSPLOT "cf\n"; 
                    }elsif("$field" eq "cld_cvr" ){ 
                        printf LAPSPLOT "cv\n"; 
                    }elsif("$field" eq "wind" ){ 
                        printf LAPSPLOT "vc\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "WIND_SPD" ) { 
                        printf LAPSPLOT "spi\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "wind_spd" ) { 
                        printf LAPSPLOT "sp\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "wind_div" ) { 
                        printf LAPSPLOT "dv\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "WIND_DIV" ) { 
                        printf LAPSPLOT "dvi\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "wind_vort" ) { 
                        printf LAPSPLOT "vo\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "WIND_VORT" ) { 
                        printf LAPSPLOT "voi\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "wind_pvort" ) { 
                        printf LAPSPLOT "pv\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "WIND_PVORT" ) { 
                        printf LAPSPLOT "pvi\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "vort_adv" ) { 
                        printf LAPSPLOT "va\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "wind_omega" ) { 
                        printf LAPSPLOT "om\n"; 
                        printf LAPSPLOT "a\n"; 
                        printf LAPSPLOT "k\n"; 
                    }elsif("$field" eq "WIND_OMEGA" ) { 
                        printf LAPSPLOT "omi\n"; 
                        printf LAPSPLOT "a\n"; 
                        printf LAPSPLOT "k\n"; 
                    }elsif("$field" eq "c_omega" ) { 
                        printf LAPSPLOT "om\n"; 
                        printf LAPSPLOT "a\n"; 
                        printf LAPSPLOT "c\n"; 
                    }elsif("$field" eq "C_OMEGA" ) { 
                        printf LAPSPLOT "omi\n"; 
                        printf LAPSPLOT "a\n"; 
                        printf LAPSPLOT "c\n"; 
                    }elsif("$field" eq "wind_u" ) { 
                        printf LAPSPLOT "u\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "WIND_U" ) { 
                        printf LAPSPLOT "ui\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "wind_v" ) { 
                        printf LAPSPLOT "v\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "WIND_V" ) { 
                        printf LAPSPLOT "vi\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "rh" ){ 
                        printf LAPSPLOT "rh\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "RH" ){ 
                        printf LAPSPLOT "rhi\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "sh" ){ 
                        printf LAPSPLOT "sh\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "SH" ){ 
                        printf LAPSPLOT "shi\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "mr" ){ 
                        printf LAPSPLOT "sh\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "MR" ){ 
                        printf LAPSPLOT "shi\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "cld_liq" ){ 
                        printf LAPSPLOT "ls\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "CLD_LIQ" ){ 
                        printf LAPSPLOT "lsi\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "cld_ice" ){ 
                        printf LAPSPLOT "ci\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "CLD_ICE" ){ 
                        printf LAPSPLOT "cii\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "cld_type" ){ 
                        printf LAPSPLOT "tc\n"; 
                    }elsif("$field" eq "REFLCT" ){ 
                        printf LAPSPLOT "ri\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "reflct" ){ 
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "pcp_typ" ){ 
                        printf LAPSPLOT "tp\n"; 
                    }elsif("$field" eq "pcp_cnc" ){ # LWC
                        printf LAPSPLOT "pc\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "pcp_rai" ){ # LWC
                        printf LAPSPLOT "rn\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "PCP_RAI" ){ # LWC
                        printf LAPSPLOT "rni\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "pcp_sno" ){ # LWC
                        printf LAPSPLOT "sn\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "PCP_SNO" ){ # LWC
                        printf LAPSPLOT "sni\n"; 
                        printf LAPSPLOT "a\n"; 
                    }else{ 
                        print "$source $level $field not available\n"; 
                    }

                }elsif("$level" eq "sndg"){ # analysis
                    if($sounding == 1){
                        printf LAPSPLOT "a\n"; 
                    }

                }else{ # Analyses - 3D
                    if   ("$field" eq "CLD_CVR" ) {   # LCP
                        printf LAPSPLOT "cg\n";  
                        printf LAPSPLOT "-$level\n"; 
                    }elsif("$field" eq "cld_cvr" ) {  # LCP
                        printf LAPSPLOT "cv\n"; 
                        printf LAPSPLOT "-$level\n"; 
                    }elsif("$field" eq "HT" ) { 
                        printf LAPSPLOT "hti\n"; 
                        printf LAPSPLOT "$level\n"; 
                    }elsif("$field" eq "ht" ) { 
                        printf LAPSPLOT "ht\n"; 
                        printf LAPSPLOT "$level\n"; 
                    }elsif("$field" eq "TEMP" ) {  # LT1
                        printf LAPSPLOT "ti\n"; 
                        printf LAPSPLOT "$level\n"; 
                    }elsif("$field" eq "temp" ) {  # LT1
                        printf LAPSPLOT "t\n"; 
                        printf LAPSPLOT "$level\n"; 
                    }elsif("$field" eq "THETA" ) { 
                        printf LAPSPLOT "pti\n"; 
                        printf LAPSPLOT "$level\n"; 
                    }elsif("$field" eq "theta" ) { 
                        printf LAPSPLOT "pt\n"; 
                        printf LAPSPLOT "$level\n"; 
                    }elsif("$field" eq "RH" ) { 
                        printf LAPSPLOT "lqi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "r\n"; 
                        printf LAPSPLOT "l\n"; 
                    }elsif("$field" eq "rh" ) { 
                        printf LAPSPLOT "lq\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "r\n"; 
                        printf LAPSPLOT "l\n"; 
                    }elsif("$field" eq "DEWPOINT" ) { 
                        printf LAPSPLOT "lqi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "d\n"; 
                        printf LAPSPLOT "l\n"; 
                    }elsif("$field" eq "dewpoint" ) { 
                        printf LAPSPLOT "lq\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "d\n"; 
                        printf LAPSPLOT "l\n"; 
                    }elsif("$field" eq "SH" ) { # LQ3
                        printf LAPSPLOT "lqi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "q\n"; 
                    }elsif("$field" eq "sh" ) { 
                        printf LAPSPLOT "lq\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "q\n"; 
                    }elsif("$field" eq "MR" ) { # LQ3
                        printf LAPSPLOT "lqi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "q\n"; 
                    }elsif("$field" eq "mr" ) { 
                        printf LAPSPLOT "lq\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "q\n"; 
                    }elsif("$field" eq "radial_vel") { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "ob\n"; 
                        printf LAPSPLOT "0\n"; 
                        printf LAPSPLOT "y\n"; 
                        printf LAPSPLOT "n\n"; 
                        printf LAPSPLOT "n\n"; 
                    }elsif("$field" eq "wind" ) { # LW3
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "vc\n"; 
                    }elsif("$field" eq "WIND_SPD" ) { 
                        printf LAPSPLOT "wdi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "sp\n"; 
                    }elsif("$field" eq "wind_spd" ) { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "sp\n"; 
                    }elsif("$field" eq "wind_div" ) { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "dv\n"; 
                    }elsif("$field" eq "WIND_DIV" ) { 
                        printf LAPSPLOT "wdi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "dv\n"; 
                    }elsif("$field" eq "wind_vort" ) { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "vo\n"; 
                    }elsif("$field" eq "WIND_VORT" ) { 
                        printf LAPSPLOT "wdi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "vo\n"; 
                    }elsif("$field" eq "wind_pvort" ) { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "pv\n"; 
                    }elsif("$field" eq "WIND_PVORT" ) { 
                        printf LAPSPLOT "wdi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "pv\n"; 
                    }elsif("$field" eq "vort_adv" ) { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "va\n"; 
                    }elsif("$field" eq "WIND_OMEGA" ) { 
                        printf LAPSPLOT "woi\n"; 
                        printf LAPSPLOT "$level\n"; 
                    }elsif("$field" eq "wind_omega" ) { 
                        printf LAPSPLOT "wo\n"; 
                        printf LAPSPLOT "$level\n"; 
                    }elsif("$field" eq "C_OMEGA" ) { 
                        printf LAPSPLOT "coi\n"; 
                        printf LAPSPLOT "$level\n"; 
                    }elsif("$field" eq "c_omega" ) { 
                        printf LAPSPLOT "co\n"; 
                        printf LAPSPLOT "$level\n"; 
                    }elsif("$field" eq "WIND_U" ) { 
                        printf LAPSPLOT "wdi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "u\n"; 
                    }elsif("$field" eq "wind_u" ) { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "u\n"; 
                    }elsif("$field" eq "WIND_V" ) { 
                        printf LAPSPLOT "wdi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "v\n"; 
                    }elsif("$field" eq "wind_v" ) { 
                        printf LAPSPLOT "wd\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "v\n"; 
                    }elsif("$field" eq "REFLCT" ) { # LPS
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "rfi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "reflct" ) { # LPS
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "rf\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "cld_liq" ) { # LWC
                        printf LAPSPLOT "ls\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "CLD_LIQ" ) { 
                        printf LAPSPLOT "lsi\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "cld_ice" ) { 
                        printf LAPSPLOT "ci\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "CLD_ICE" ) { 
                        printf LAPSPLOT "cii\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "pcp_cnc" ) { 
                        printf LAPSPLOT "pc\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "pcp_rai" ) { 
                        printf LAPSPLOT "rn\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "pcp_sno" ) { 
                        printf LAPSPLOT "sn\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "a\n"; 
                    }elsif("$field" eq "cld_type" ) { 
                        printf LAPSPLOT "cy\n"; 
                        printf LAPSPLOT "$level\n"; 
                    }elsif("$field" eq "pcp_typ" ) { 
                        printf LAPSPLOT "py\n"; 
                        printf LAPSPLOT "$level\n"; 
                        printf LAPSPLOT "a\n"; 
                    }else{ 
                        print "$source $level mb $field not available\n"; 

                          } # if field

                      } # if level

                  }elsif("$source" eq "balanced"){
                      if("$level" eq "sfc/2d"){

                          if("$field" eq "wind" ) {      # lsx
                              printf LAPSPLOT "bw\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "vc\n"; 
                          }elsif("$field" eq "wind_u" ) { 
                              printf LAPSPLOT "wd\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "u\n"; 
                          }elsif("$field" eq "WIND_U" ) { 
                              printf LAPSPLOT "wdi\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "u\n"; 
                          }elsif("$field" eq "wind_v" ) { 
                              printf LAPSPLOT "wd\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "v\n"; 
                          }elsif("$field" eq "WIND_V" ) { 
                              printf LAPSPLOT "wdi\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "v\n"; 
                          }elsif("$field" eq "wind_spd" ) { 
                              printf LAPSPLOT "wd\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "sp\n"; 
                          }elsif("$field" eq "WIND_SPD" ) { 
                              printf LAPSPLOT "wdi\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "sp\n"; 
                          }elsif("$field" eq "wind_div" ) { 
                              printf LAPSPLOT "wd\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "dv\n"; 
                          }elsif("$field" eq "WIND_DIV" ) { 
                              printf LAPSPLOT "wdi\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "dv\n"; 
                          }elsif("$field" eq "temp"){     
                              printf LAPSPLOT "by\n"; 
                              if($units eq "metric"){
                                  printf LAPSPLOT "tc\n"; 
                              }else{
                                  printf LAPSPLOT "tf\n"; 
                              }
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "TEMP"){     
                              printf LAPSPLOT "by\n"; 
                              if($units eq "metric"){
                                  printf LAPSPLOT "tci\n"; 
                              }else{
                                  printf LAPSPLOT "tfi\n"; 
                              }
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "dewpoint"){ 
                              printf LAPSPLOT "by\n"; 
                              if($units eq "metric"){
                                  printf LAPSPLOT "dc\n"; 
                              }else{
                                  printf LAPSPLOT "df\n"; 
                              }
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "DEWPOINT"){ 
                              printf LAPSPLOT "by\n"; 
                              if($units eq "metric"){
                                  printf LAPSPLOT "dci\n"; 
                              }else{
                                  printf LAPSPLOT "dfi\n"; 
                              }
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "RH"){ 
                              printf LAPSPLOT "by\n"; 
                              printf LAPSPLOT "hui\n"; 
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "rh"){ 
                              printf LAPSPLOT "by\n"; 
                              printf LAPSPLOT "hu\n";  
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "wind_vort"){ 
                              printf LAPSPLOT "by\n"; 
                              printf LAPSPLOT "vo\n"; 
                          }elsif("$field" eq "WIND_VORT"){ 
                              printf LAPSPLOT "by\n"; 
                              printf LAPSPLOT "voi\n"; 
                          }elsif("$field" eq "sh"){ 
                              printf LAPSPLOT "by\n"; 
                              printf LAPSPLOT "mr\n"; 
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "SH"){ 
                              printf LAPSPLOT "by\n"; 
                              printf LAPSPLOT "mri\n"; 
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "mr"){ 
                              printf LAPSPLOT "by\n"; 
                              printf LAPSPLOT "mr\n"; 
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "MR"){ 
                              printf LAPSPLOT "by\n"; 
                              printf LAPSPLOT "mri\n"; 
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "p_msl"){ 
                              printf LAPSPLOT "by\n"; 
                              printf LAPSPLOT "pm\n"; 
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "red_p"){ 
                              printf LAPSPLOT "by\n"; 
                              printf LAPSPLOT "p\n"; 
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "stn_p"){ 
                              printf LAPSPLOT "by\n"; 
                              printf LAPSPLOT "ps\n"; 
                              printf LAPSPLOT "bn\n"; 
                          }elsif("$field" eq "HT" ){ 
                              printf LAPSPLOT "gg\n"; 
                              printf LAPSPLOT "tni\n"; 
                          }elsif("$field" eq "ht" ){ 
                              printf LAPSPLOT "gg\n"; 
                              printf LAPSPLOT "tn\n"; 
                          }else{
                              print "$source sfc $field not available\n"; 
                          }

                      }elsif("$level" eq "xsect"){ # balanced
                          if   ("$field" eq "temp" ){ 
                              printf LAPSPLOT "tb\n";  
                          }elsif("$field" eq "TEMP" ){ 
                              printf LAPSPLOT "tbi\n";  
                          }elsif("$field" eq "HT" ) { 
                              printf LAPSPLOT "hbi\n"; 
                          }elsif("$field" eq "ht" ) { 
                              printf LAPSPLOT "hb\n"; 
                          }elsif("$field" eq "THETA" ){ 
                              printf LAPSPLOT "pbi\n";  
                          }elsif("$field" eq "theta" ){ 
                              printf LAPSPLOT "pb\n";  
                          }elsif("$field" eq "thetae" ){ 
                              printf LAPSPLOT "be\n";  
                          }elsif("$field" eq "THETAE" ){ 
                              printf LAPSPLOT "bei\n";  
                          }elsif("$field" eq "CLD_CVR" ){ # defaults over to analyzed
                              printf LAPSPLOT "cf\n"; 
                          }elsif("$field" eq "cld_cvr" ){ # defaults over to analyzed
                              printf LAPSPLOT "cv\n"; 
                          }elsif("$field" eq "c_omega" ) { # defaults over to analyzed
                              printf LAPSPLOT "om\n"; 
                              printf LAPSPLOT "a\n"; 
                              printf LAPSPLOT "c\n"; 
                          }elsif("$field" eq "C_OMEGA" ) { # defaults over to analyzed
                              printf LAPSPLOT "omi\n"; 
                              printf LAPSPLOT "a\n"; 
                              printf LAPSPLOT "c\n"; 
                          }elsif("$field" eq "cld_type" ){ # defaults over to analyzed
                              printf LAPSPLOT "tc\n"; 
                          }elsif("$field" eq "wind" ){ 
                              printf LAPSPLOT "vc\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "wind_spd" ) { 
                              printf LAPSPLOT "sp\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "WIND_SPD" ) { 
                              printf LAPSPLOT "spi\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "wind_div" ) { 
                              printf LAPSPLOT "dv\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "WIND_DIV" ) { 
                              printf LAPSPLOT "dvi\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "wind_vort" ) { 
                              printf LAPSPLOT "vo\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "WIND_VORT" ) { 
                              printf LAPSPLOT "voi\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "wind_pvort" ) { 
                              printf LAPSPLOT "pv\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "WIND_PVORT" ) { 
                              printf LAPSPLOT "pvi\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "vort_adv" ) { 
                              printf LAPSPLOT "va\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "wind_omega" ) { 
                              printf LAPSPLOT "om\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "WIND_OMEGA" ) { 
                              printf LAPSPLOT "omi\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "wind_u" ) { 
                              printf LAPSPLOT "u\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "WIND_U" ) { 
                              printf LAPSPLOT "ui\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "wind_v" ) { 
                              printf LAPSPLOT "v\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "WIND_V" ) { 
                              printf LAPSPLOT "vi\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "rh" ){ 
                              printf LAPSPLOT "rl\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "RH" ){ 
                              printf LAPSPLOT "rli\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "sh" ){ 
                              printf LAPSPLOT "sh\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "SH" ){ 
                              printf LAPSPLOT "shi\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "mr" ){ 
                              printf LAPSPLOT "sh\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "MR" ){ 
                              printf LAPSPLOT "shi\n"; 
                              printf LAPSPLOT "n\n"; 
                          }elsif("$field" eq "cld_liq" ){ 
                              printf LAPSPLOT "ls\n"; 
                          }elsif("$field" eq "cld_ice" ){ 
                              printf LAPSPLOT "ci\n"; 
                          }elsif("$field" eq "REFLCT" ){ 
                              printf LAPSPLOT "ri\n"; 
                              printf LAPSPLOT "a\n"; 
                          }elsif("$field" eq "reflct" ){  
                              printf LAPSPLOT "rf\n"; 
                              printf LAPSPLOT "a\n"; 
                          }elsif("$field" eq "pcp_typ" ){ 
                              printf LAPSPLOT "tp\n"; 
                          }else{ 
                              print "$source $level $field not available\n"; 
                          }

                      }elsif("$level" eq "sndg"){ # Balanced Sounding
                          if($sounding == 1){
                              printf LAPSPLOT "n\n"; 
                          }

                      }else{               # 3D Balanced analyses
                          if   ("$field" eq "ht" ) { 
                              printf LAPSPLOT "bh\n"; 
                              printf LAPSPLOT "$level\n"; 

                          }elsif("$field" eq "HT" ) { 
                              printf LAPSPLOT "bhi\n"; 
                              printf LAPSPLOT "$level\n"; 

                          }elsif("$field" eq "temp" ) { 
                              printf LAPSPLOT "bt\n"; 
                              printf LAPSPLOT "$level\n"; 

                          }elsif("$field" eq "TEMP" ) { 
                              printf LAPSPLOT "bti\n"; 
                              printf LAPSPLOT "$level\n"; 

                          }elsif("$field" eq "dewpoint" ) { 
                              printf LAPSPLOT "rb\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "d\n"; 
                              printf LAPSPLOT "l\n"; 

                          }elsif("$field" eq "DEWPOINT" ) { 
                              printf LAPSPLOT "rbi\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "d\n"; 
                              printf LAPSPLOT "l\n"; 

                          }elsif("$field" eq "theta" ) { 
                              printf LAPSPLOT "pb\n"; 
                              printf LAPSPLOT "$level\n"; 

                          }elsif("$field" eq "THETA" ) { 
                              printf LAPSPLOT "pbi\n"; 
                              printf LAPSPLOT "$level\n"; 

                          }elsif("$field" eq "radial_vel") { 
                              printf LAPSPLOT "wd\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "ob\n"; 
                              printf LAPSPLOT "0\n"; 
                              printf LAPSPLOT "y\n"; 
                              printf LAPSPLOT "n\n"; 
                              printf LAPSPLOT "n\n"; 

                          }elsif("$field" eq "wind" ) { 
                              printf LAPSPLOT "bw\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "vc\n"; 

                          }elsif("$field" eq "WIND_SPD" ) { 
                              printf LAPSPLOT "bwi\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "sp\n"; 

                          }elsif("$field" eq "wind_spd" ) { 
                              printf LAPSPLOT "bw\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "sp\n"; 

                          }elsif("$field" eq "wind_u" ) { 
                              printf LAPSPLOT "bw\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "u\n"; 

                          }elsif("$field" eq "WIND_U" ) { 
                              printf LAPSPLOT "bwi\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "u\n"; 

                          }elsif("$field" eq "wind_v" ) { 
                              printf LAPSPLOT "bw\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "v\n"; 

                          }elsif("$field" eq "WIND_V" ) { 
                              printf LAPSPLOT "bwi\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "v\n"; 

                          }elsif("$field" eq "wind_div" ) { 
                              printf LAPSPLOT "bw\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "dv\n"; 

                          }elsif("$field" eq "WIND_DIV" ) { 
                              printf LAPSPLOT "bwi\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "dv\n"; 

                          }elsif("$field" eq "wind_vort" ) { 
                              printf LAPSPLOT "bw\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "vo\n"; 

                          }elsif("$field" eq "WIND_VORT" ) { 
                              printf LAPSPLOT "bwi\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "vo\n"; 

                          }elsif("$field" eq "wind_pvort" ) { 
                              printf LAPSPLOT "bw\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "pv\n"; 

                          }elsif("$field" eq "WIND_PVORT" ) { 
                              printf LAPSPLOT "bwi\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "pv\n"; 

                          }elsif("$field" eq "vort_adv" ) { 
                              printf LAPSPLOT "bw\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "va\n"; 

                          }elsif("$field" eq "wind_omega" ) { 
                              printf LAPSPLOT "bo\n"; 
                              printf LAPSPLOT "$level\n"; 
      
                          }elsif("$field" eq "WIND_OMEGA" ) { 
                              printf LAPSPLOT "boi\n"; 
                              printf LAPSPLOT "$level\n"; 

                          }elsif("$field" eq "C_OMEGA" ) { 
                              printf LAPSPLOT "coi\n"; 
                              printf LAPSPLOT "$level\n"; 

                          }elsif("$field" eq "c_omega" ) { 
                              printf LAPSPLOT "co\n"; 
                              printf LAPSPLOT "$level\n"; 

                          }elsif("$field" eq "REFLCT" ) { 
                              printf LAPSPLOT "rf\n"; 
                              printf LAPSPLOT "rfi\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "a\n"; 

                          }elsif("$field" eq "reflct" ) { 
                              printf LAPSPLOT "rf\n"; 
                              printf LAPSPLOT "rf\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "a\n"; 

                          }elsif("$field" eq "cld_type" ) { 
                              printf LAPSPLOT "cy\n"; 
                              printf LAPSPLOT "$level\n"; 

                          }elsif("$field" eq "RH" ) { 
                              printf LAPSPLOT "rbi\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "rh\n"; 
#                             printf LAPSPLOT "l\n"; 

                          }elsif("$field" eq "rh" ) { 
                              printf LAPSPLOT "rb\n"; 
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "rh\n"; 
#                             printf LAPSPLOT "l\n"; 

                          }elsif("$field" eq "SH" ) { 
                              printf LAPSPLOT "rbi\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "q\n"; 

                          }elsif("$field" eq "sh" ) { 
                              printf LAPSPLOT "rb\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "q\n"; 

                          }elsif("$field" eq "MR" ) { 
                              printf LAPSPLOT "rbi\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "q\n"; 

                          }elsif("$field" eq "mr" ) { 
                              printf LAPSPLOT "rb\n"; 
                              printf LAPSPLOT "$hhmm\n";
                              printf LAPSPLOT "$level\n"; 
                              printf LAPSPLOT "q\n"; 

                          }else{
                              print "$source $level mb $field not available\n"; 

                          } # if field

                      } # if level
           
                  }else{ 
                      print "$source not yet available...\n"; 

                  } # if source

               } # foreach level 
            } # foreach field (did we lose track of the braces somewhere?)
        } # if source eq WGI/DIFF 
      } # foreach source
    } # foreach domain
  
#   print "frames_safe at loop end = $frames_safe\n";

    $frames_safe = $frames_safe - 1;

    printf LAPSPLOT "q\n";

  } # while frames > 0

  printf LAPSPLOT "q\n";
  close LAPSPLOT;

# $laps_data_root = $DomainDir/$domain/data;

# print "laps_data_root = $laps_data_root<br>";

  my $window;
  my $resolution;
  my $res_x;
  my $res_y;

  my $xhigh;
  my $xlow;
  my $yhigh;
  my $ylow;
  my $yhigh_thresh;
  my $ylow_thresh;
  my $x_hw;
  my $y_hw;

# Read grid dimensions
  my $xdim;
  my $ydim;
  $domain_nl = "nest7grid.parms";
  if(-e "$laps_data_root/static/$domain_nl"){
    $nl_var="NX_L";
    @xdim=&laps_tools::get_nl_value($domain_nl,$nl_var,$laps_data_root);
    $nl_var="NY_L";
    @ydim=&laps_tools::get_nl_value($domain_nl,$nl_var,$laps_data_root);
    $xdim = @xdim[0];
    $ydim = @ydim[0];
#   print "xdim,ydim is $xdim,$ydim<br>\n";
  }

  my $aspect_ratio = ($xdim-1.0) / ($ydim-1.0);
# print "aspect_ratio is $aspect_ratio<br>\n";

# print "sect/window 4 = $sect $window\n";

# Run lapsplot and generate the GIF here
  if($sect eq "hsect"){
    $x_hw  = 0.5 / $zoom_safe;
#   if($domain_first eq "co" || $domain_first =~ "co_prl" || $domain_first =~ "ruc20" || $domain_first =~ "t2" || $domain_first =~ "goes"){
    if($aspect_ratio > 1.40){
        $res_y=$npix_safe;
        $res_x=int($res_y*1200./885.);
        $resolution="$res_x"."x"."$res_y";
        $y_hw  = 0.36 / $zoom_safe;
        $ylow_thresh  = 0.14;
        $yhigh_thresh = 0.86;
    }elsif($aspect_ratio > 1.192){
        $res_y=$npix_safe;
        $res_x=int($res_y*1056./885.);
        $resolution="$res_x"."x"."$res_y";
        $y_hw  = 0.42 / $zoom_safe;
        $ylow_thresh  = 0.08;
        $yhigh_thresh = 0.92;
    }else{
        $res_y=$npix_safe;
        $res_x=$res_y;
        $resolution="$res_x"."x"."$res_y";
        $y_hw  = 0.5 / $zoom_safe;
        $ylow_thresh  = 0.0;
        $yhigh_thresh = 1.0;
    }

#   print "resolution is $resolution<br>\n";

    $xlow  = $xcen_safe - $x_hw;
    $xhigh = $xcen_safe + $x_hw;
    $ylow  = $ycen_safe - $y_hw;
    $yhigh = $ycen_safe + $y_hw;


#   Correct parms if they are invalid
#   $window="$xlow:$ylow:$xhigh:$yhigh";
#   print "window initially is $window<br>\n";

#   print "ycen_safe is $ycen_safe<br>\n";

    if($xlow < 0.){
        $xhigh = $xhigh - $xlow;
        $xcen_safe  = $xcen_safe  - $xlow;
        $xlow  = 0.;
    }elsif($xhigh > 1.){
        $xlow  = $xlow - ($xhigh - 1.0);
        $xcen_safe  = $xcen_safe - ($xhigh - 1.0);
        $xhigh = 1.0;
    }

    if($ylow < $ylow_thresh){
        $yhigh =      $yhigh      + ($ylow_thresh - $ylow);
        $ycen_safe  = $ycen_safe  + ($ylow_thresh - $ylow);
        $ylow       = $ylow_thresh;
    }elsif($yhigh > $yhigh_thresh){
        $ylow       = $ylow -      ($yhigh - $yhigh_thresh);
        $ycen_safe  = $ycen_safe - ($yhigh - $yhigh_thresh);
        $yhigh      = $yhigh_thresh;
    }

#   $xcen_safe = ($xlow + $xhigh) / 2.0;
#   $ycen_safe = ($ylow + $yhigh) / 2.0;

    $window="$xlow:$ylow:$xhigh:$yhigh";
#   print "window (corrected) is $window<br>\n";

  }elsif($sect eq "sndg"){ # Sounding
    $res_y=$npix_safe;
    $res_x=$res_y;
#   $resolution="885x885";
    $resolution="$res_x"."x"."$res_y";
    $window="0.00:0.00:1.00:1.00";

    if($ycen_safe =~ "l"){ # lat/lon mode
    }else{
      if($xcen_safe < 1){
         $xcen_safe = 1;
      }
      if($ycen_safe < 1){
         $ycen_safe = 1;
      }
    }

  }else{ # xsect
#   $resolution="1056x885";
    $res_y=$npix_safe;
    $res_x=int($res_y*1.192 + .5);
#   $res_x=$res_y;
    $resolution="$res_x"."x"."$res_y";
#   $window="0.06:0.14:0.94:0.86";
    $window="0.06:0.13:0.94:0.85";

  }

# print "sect/window 5 = $sect $window\n";

# Set Up Machine, Shell, and Image Type
# my $machine = "jayhawk"; # This won't work until we enable ssh on pubweb@arac
# my $shell = "/usr/local/bin/ssh";
# my $image_type = "jpg";

  my $machine = "tst1-100";      # hugo / ren also works but can have long runtimes
  my $shell = " ";
  my $image_type = "gif";

  my $exedir;
  my $ncarg_root;

  $ncarg_root = "/usr/local/apps/ncarg-4.3.1.LINUX9";
  $exedir = "/usr/nfs/lapb/builds64/laps/bin";

  if ($wgi_only == 0) {
#   print  "$request_root/lapsplot/lapsplot_gifs.sh $$ $window $request_root/lapsplot $web_root/$ScratchDir/lapsplot.in_$$ $exedir $laps_data_root $ncarg_root $animate $resolution\n";
    if ($montage == 1) {
        $animate = "montage";
    } 
    system("$request_root/lapsplot/lapsplot_gifs.sh $$ $window $request_root/lapsplot $delay_safe $exedir $laps_data_root $ncarg_root $animate $resolution 1> $web_root/$ScratchDir/lapsplot.out_$$ 2> $web_root/$ScratchDir/lapsplot.err_$$"); 
    system("rm -f $request_root/lapsplot/lapsplot.in; ln -s $web_root/$ScratchDir/lapsplot.in_$$ $request_root/lapsplot/lapsplot.in; rm -f $request_root/lapsplot/lapsplot.out; ln -s $web_root/$ScratchDir/lapsplot.out_$$ $request_root/lapsplot/lapsplot.out; rm -f $request_root/lapsplot/lapsplot.err; ln -s $web_root/$ScratchDir/lapsplot.err_$$ $request_root/lapsplot/lapsplot.err; rm -f $request_root/lapsplot/loop; ln -s $web_root/$ScratchDir/$$ $request_root/lapsplot/loop");
    print<<"EOI";
    <A HREF=\"/$ScratchDir/gmeta_$$.gm\">gmeta file</A>
    |
    <A HREF=\"/$ScratchDir/selected.in_$$\">parms file</A>
    <p>
    <center>
    <img src=\"/$ScratchDir/gmeta_$$.$image_type\">

    </body></html>

EOI
  }else{
    print<<"EOI";
    <p>
    <center>
    <IMG SRC="/albers/colorbar.gif">
    </body></html>

EOI
  }

# print " test output: write selected.in file \n"; 
# print "forecast_time = $forecast_time ";
# print "hhmm = $hhmm ";


# Write a selected.in file
  $logFile = "$web_root/$ScratchDir/selected.in_$$";
  open(SELECTED,">$logFile") ||
    die "Content-type: text/html\n\nCan't open $logFile: $!\n";
# printf SELECTED "$domain_first\n";
  printf SELECTED "@domains\n";
  printf SELECTED "@sources\n";
  printf SELECTED "@fields\n";
  printf SELECTED "@pressure_levels\n";
  printf SELECTED "$a9time\n";
  printf SELECTED "$forecast_time\n";
  printf SELECTED "$zoom_safe\n";
  printf SELECTED "$xcen_safe\n";
  printf SELECTED "$ycen_safe\n";
  printf SELECTED "$density_safe\n";
  printf SELECTED "$thickness_safe\n";
# printf SELECTED "$size_safe\n";
  printf SELECTED "$npix_safe\n";
  printf SELECTED "$frames_orig\n";
  printf SELECTED "$delay_safe\n";
  close SELECTED;

  system("rm -f $request_root/lapsplot/selected.in; ln -s $web_root/$ScratchDir/selected.in_$$ $request_root/lapsplot/selected.in");

# get best return address for log
  $returnAddress = ($ENV{'REMOTE_HOST'} || $ENV{REMOTE_ADDR} ||
                  "(Unknown requestor)");

  $logFile = "$thisDir/laps_request.log";
  open(LOG,">>$logFile") ||
        die "Content-type: text/html\n\nCan't open $logFile: $!\n";
# get time for log file
  $time = time();
  ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = gmtime($time);
  $thisMonth=$month[$mon];
  $nHours=($stopSecs+1-$startSecs)/3600;
  printf LOG "%02d-$thisMonth-$year-%02d%02dZ $returnAddress " .
             "%3.1f (%4.1f,%4.1f) ".
             " $out_levels %s\n"
             ,$mday,$hour,$min,$density,$thickness,$a9time,$CenterLon,
             $ENV{'REMOTE_USER'};
  close LOG;

  $logFile = "$web_root/cgi/laps_anal_products.cgi.log";
  open(LOG,">>$logFile") ||
        die "Content-type: text/html\n\nCan't open $logFile: $!\n";
# get time for log file
  $time = time();
  ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = gmtime($time);
  $thisMonth=$month[$mon];
  $nHours=($stopSecs+1-$startSecs)/3600;
  $year=$year+1900;
  printf LOG "....$thisMonth $mday %02d\:%02d\:%02d UTC $year  $returnAddress " .
             " $domain_first $out_sources %s $out_fields %s $out_levels %s\n"
             ,$hour,$min,$sec,
             $ENV{'REMOTE_USER'};
  close LOG;

  $LOG_USER = $ENV{'REMOTE_USER'};

}else{ # $err

# Specify default values
  $zoom_safe = 1.0;
  $xcen_safe = 0.5;
  $ycen_safe = 0.5;
  $density_safe = 1.0;
  $thickness_safe = 1;
  $frames_safe = 1;
  $delay_safe = 75;
# $size_safe = 1;
  $npix_safe = 885;
  @domains = "co";

# Write a selected.in file to update the domain values
  $logFile = "$web_root/$ScratchDir/selected.in_$$";
  open(SELECTED,">$logFile") ||
        die "Content-type: text/html\n\nCan't open $logFile: $!\n";
  printf SELECTED "@domains\n";
  printf SELECTED "@sources\n";
  printf SELECTED "@fields\n";
  printf SELECTED "@pressure_levels\n";
  printf SELECTED "$a9time\n";
  printf SELECTED "$hhmm\n";
  printf SELECTED "$zoom_safe\n";
  printf SELECTED "$xcen_safe\n";
  printf SELECTED "$ycen_safe\n";
  printf SELECTED "$density_safe\n";
  printf SELECTED "$thickness_safe\n";
# printf SELECTED "$size_safe\n";
  printf SELECTED "$npix_safe\n";
  printf SELECTED "$frames_safe\n";
  printf SELECTED "$delay_safe\n";
  close SELECTED;

  system("rm -f $request_root/lapsplot/selected.in; ln -s $web_root/$ScratchDir/selected.in_$$ $request_root/lapsplot/selected.in");

} # $err

#print " test output: End of nph-laps.cgi - calling laps.cgi \n"; 

system("$web_root/request/laps.cgi");

#system("$web_root/cgi/log-access.s $logFile $LOG_USER request_$domain_first");
#           "%3.1f".
