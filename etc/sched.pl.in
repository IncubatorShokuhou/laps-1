#!@PERL@
# @confiure_input@
# Run the LAPS suite of programs 
#
# Copyright (C) 1998  James P. Edwards
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#
#

use strict;
use Getopt::Std;
my($opt_o);
getopt('o');

umask 002;
my $cycle_time = 3600;
my $initial_time = time();
#
# List here the laps products to be executed in the order that they should 
# be executed.
#

my @LAPS_EXE = qw(lga.exe systime.exe obs_driver.x 
                  ingest_raob.exe 
                  ingest_cloud_drift.exe ingest_pireps.exe ingest_acars.exe 
                  ingest_pro.exe ingest_blppro.exe ingest_vad.exe
		  wind.exe 
                  ingest_lrs.exe ingest_blplrs.exe 
                  laps_sfc.x temp.exe 
                  lvd_sat_ingest.exe cloud.exe lq3driver.x deriv.exe accum.exe  
		  lsm5.exe ingest_lsr_tiros.exe);

my $LAPSROOT=shift || die "LAPS root directory required\n";
require "$LAPSROOT/etc/fxa.pm";

$ENV{PATH}.=":@NETCDFBIN@";

my $fxa_sys =  &Get_env'fxa; #'

$ENV{LAPS_DATA_ROOT} = shift ;
$ENV{LAPS_DATA_ROOT} = "$LAPSROOT/data" if ! $ENV{LAPS_DATA_ROOT};
my $LAPS_DATA_ROOT = $ENV{LAPS_DATA_ROOT};
#
# This sends the stdout to the run log file
#
my $hh = (gmtime)[2];
my $mm = (gmtime)[1];
my $hhmm = 100*$hh+$mm;
$hhmm = "0".$hhmm while(length($hhmm)<4);
my($LAPS_LOG_PATH);
if($fxa_sys!=0){
    $LAPS_LOG_PATH = &Set_logdir'fxa; #'
}else{
    $LAPS_LOG_PATH = "$LAPS_DATA_ROOT/log";
}

unless($opt_o){
    open(SAVEOUT,">&STDOUT");
    open(SAVEERR,">&STDERR");
    open(STDOUT, ">$LAPS_LOG_PATH/sched.log.$hhmm") || die "Can't redirect stdout";
    open(STDERR, ">&STDOUT") || die "Can't dup stdout";
    select(STDERR); $| = 1;
    select(STDOUT); $| = 1;
}


my $t=gmtime(); print $t." Running purger\n";
system("@PERL@ $LAPSROOT/etc/purger.pl $LAPS_DATA_ROOT/lapsprd");
open(LOG,">>$LAPS_LOG_PATH/runtime.log");
my($exe);
foreach $exe (@LAPS_EXE){
    $t=gmtime(); 
    my $log = $exe;
    $log =~ s/\..*$/\.log\.$hhmm/;
    if(-x  "$LAPSROOT/bin/$exe"){
	print $t." Running $exe\n";
	system("$LAPSROOT/bin/$exe 1> $LAPS_LOG_PATH/$log 2>&1");
    }else{
	print $t."WARNING: $exe not found\n";
    }
    my $cur_time = time();
    if($cur_time-$initial_time>$cycle_time){
	print "ERROR: Exceeding LAPS cycle time in $0 exiting after $exe\n";
	print LOG "ERROR: Exceeding LAPS cycle time in $0 exiting after $exe\n";
	last;
    }
}

$t = gmtime;

print LOG "$t\n";
close(LOG);


if($fxa_sys!=0){
    print LOG $t." Running wfo postprocessing\n";
    system("@PERL@ $LAPSROOT/etc/wfo_post.pl $LAPSROOT $LAPS_DATA_ROOT 1> $LAPS_LOG_PATH/wfo_post.log.$hhmm 2>&1");
}






