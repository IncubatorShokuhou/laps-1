#!@CSH@

setenv LAPSINSTALLROOT @prefix@
setenv LAPS_DATA_ROOT $1
setenv LOGDIR $LAPS_DATA_ROOT/log

# parse cloud logfiles to make a temporary data file for input to gnuplot
# this could eventually be done from the WGI script so we just grep one log file at a time
setenv file $LOGDIR/cloud_gp.log
echo "parsed log file = $file"
cd $LOGDIR
grep gnuplot cloud.wgi.* | cut -c22-100 > $file

# obtain xrange times from the data file
setenv STARTTIME1 `head -1 $file | cut -c1-11` ; echo $STARTTIME1
setenv STARTTIME2 `head -1 $file | cut -c13-23`; echo $STARTTIME2
setenv STOPTIME1  `tail -1 $file | cut -c1-11` ; echo $STOPTIME1
setenv STOPTIME2  `tail -1 $file | cut -c13-23`; echo $STOPTIME2

# Construct gnuplot .gp file
setenv GNUPLOTFILE $LOGDIR/cloud_analysis.gp
setenv DQUOTE \"
echo 'set terminal png size 1200,800'                    > $GNUPLOTFILE
echo 'set xdata time'                                   >> $GNUPLOTFILE
echo 'set timefmt "%d-%b-%Y %H:%M:%S"'                  >> $GNUPLOTFILE
echo 'set output '$DQUOTE$LOGDIR'/load.png'$DQUOTE      >> $GNUPLOTFILE
echo '' >> $GNUPLOTFILE
echo '# time range must be in same format as data file' >> $GNUPLOTFILE
echo 'set xrange ['$DQUOTE$STARTTIME1' '$STARTTIME2$DQUOTE':'$DQUOTE$STOPTIME1' '$STOPTIME2$DQUOTE']' >> $GNUPLOTFILE
echo 'set yrange [0:1000]'                              >> $GNUPLOTFILE
echo 'set grid'                                         >> $GNUPLOTFILE
echo 'set xlabel "Date Time"'                           >> $GNUPLOTFILE
echo 'set ylabel "Solar Radiation (W/m**2)"'            >> $GNUPLOTFILE
echo 'set title "Global Solar Radiation Observed vs Analyzed"' >> $GNUPLOTFILE
echo 'set key left box'                                 >> $GNUPLOTFILE
echo 'plot '$DQUOTE$file$DQUOTE' using 1:3 title "Analyzed" with linespoints lw 3 pt 6 ps 1, \' >> $GNUPLOTFILE
echo        $DQUOTE$file$DQUOTE' using 1:4 title "Observed" with linespoints lw 3 pt 6 ps 1, \' >> $GNUPLOTFILE
echo        $DQUOTE$file$DQUOTE' using 1:5 title "RMS"      with linespoints lw 3 pt 7 ps 1'    >> $GNUPLOTFILE


# Run gnuplot
gnuplot < $GNUPLOTFILE

echo " "
echo "outputs..."
ls -l $GNUPLOTFILE
ls -l $LOGDIR/load.png

