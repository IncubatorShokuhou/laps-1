#!@CSH@    

setenv LAPSINSTALLROOT @prefix@ 
setenv LAPS_DATA_ROOT $1                                  
setenv MODELVTIME $2
setenv N_FCST_TIMES $3

echo "MODELVTIME is $MODELVTIME"

setenv VERIF_INTVL      `@PERL@ @prefix@/etc/read_nl.pl -d $LAPS_DATA_ROOT -n nest7grid.parms -v verif_intvl`
setenv N_VERIF_STEPS    `@PERL@ @prefix@/etc/read_nl.pl -d $LAPS_DATA_ROOT -n nest7grid.parms -v n_verif_steps`
setenv MODEL_FCST_INTVL `@PERL@ @prefix@/etc/read_nl.pl -d $LAPS_DATA_ROOT -n nest7grid.parms -v model_fcst_intvl`

echo "VERIF_INTVL is $VERIF_INTVL"
echo "N_VERIF_STEPS is $N_VERIF_STEPS"
echo "MODEL_FCST_INTVL is $MODEL_FCST_INTVL"

foreach EXE (obs_driver)
  setenv BINARY $EXE.x

  setenv STEP 0
  while ($STEP <= $N_VERIF_STEPS)
    echo " "
    echo "STEP = $STEP"
                                        
#   Note that this is hardwired for hourly forecast intervals at present
    @ FCST_SEC = $STEP * $MODEL_FCST_INTVL
                        perl $LAPSINSTALLROOT/etc/timeconv.pl -a $MODELVTIME -t $FCST_SEC
    echo               "perl $LAPSINSTALLROOT/etc/timeconv.pl -a $MODELVTIME -t $FCST_SEC" 
    setenv LAPS_A9TIME `perl $LAPSINSTALLROOT/etc/timeconv.pl -a $MODELVTIME -t $FCST_SEC`

    if (-e /w3/lapb) then # FAB machine, so we can go back to the short path to /public
        if ($EXE == "obs_driver") then
            @prefix@/util/fix_net  /scratch2/portfolios/BMC/public /public $LAPS_DATA_ROOT/static/obs_driver.nl
            echo "convert long /public path to short path"
            ls -l $LAPS_DATA_ROOT/static/obs_driver.nl
        endif
    endif

    date -u
    echo "running $LAPS_A9TIME $BINARY"
    $LAPSINSTALLROOT/bin/$BINARY > $LAPS_DATA_ROOT/log/$EXE.log.rerun_$LAPS_A9TIME
    ls -l $LAPS_DATA_ROOT/lapsprd/lso/$LAPS_A9TIME.lso
    ls -l $LAPS_DATA_ROOT/log/$EXE.log.rerun_$LAPS_A9TIME

    @ STEP = $STEP + 1
  end # STEP up to N_VERIF_STEPS 

end

echo "rerun complete"

