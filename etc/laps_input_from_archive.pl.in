#!@PERL@

# This script pulls raw data needed for LAPS from the MASS store
# You should have a MASS store account to run this

# Options:
#
# -p root data for output "raw" data (analogous to /public)
#
# -t time desired for data (YYYYMMDD)
#
# -m desired model background (e.g. ruc or gfs)
#
# -g degrib model background data (supply installroot for the degrib software)
#
# -s desired satellite (e.g. use 8 for goes8)
#
# -S skip all standard data download from the MSS

# Require PERL version 5 or newer
require 5;

# Set permissions
umask 002;

# Load packages
use Getopt::Std;
use Time::Local;

# Define command line variables
# opt_t: time (GMT) of LAPS analysis in YYYYMMDD
use vars qw($opt_p $opt_t $opt_m $opt_g $opt_s $opt_S);

getopts('p:t:m:s:g:S');

my $public = $opt_p;
my ($analysis_yr, $analysis_mo, $analysis_dy, );
print "$public\n";
print "$opt_t\n";
if ($opt_t =~ /^(\d\d\d\d)(\d\d)(\d\d)$/) {
 $analysis_yr = $1;
 $analysis_mo = $2;
 $analysis_dy = $3;
}else{
 print "Unrecognized date format. Should be YYYYMMDD. \n";
 exit;
}

if (! defined $opt_S) { 

    print "Get metar\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/metar/netcdf/\* $public/data/metar/netcdf/");
    chdir "$public/data/metar/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 
#    unlink "\*\.tar";


    print "Get madis\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/madis/LDAD/mesonet/netCDF/\* $public/data/madis/LDAD/mesonet/netCDF/");
    chdir "$public/data/madis/LDAD/mesonet/netCDF/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 



    print "Get maritime\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/maritime/netcdf/\* $public/data/maritime/netcdf/");
    chdir "$public/data/maritime/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get wsi-nexrad\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/radar/wsi/nexrad/netcdf/\* $public/data/radar/wsi/nexrad/netcdf/");
    chdir "$public/data/radar/wsi/nexrad/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get wsi-nowrad\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/radar/wsi/nowrad/netcdf/\* $public/data/radar/wsi/nowrad/netcdf/");
    chdir "$public/data/radar/wsi/nowrad/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get gps\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/gpsmet/netcdf/\* $public/data/gpsmet/netcdf/");
    chdir "$public/data/gpsmet/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get radiometer\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/madis/point/radiometer/netcdf/\* $public/data/madis/point/radiometer/netcdf/");
    chdir "$public/data/madis/point/radiometer/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get fsl-conus\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/fsl-conus/gs/netcdf/\* $public/data/sat/fsl-conus/gs/netcdf/");
    chdir "$public/data/sat/fsl-conus/gs/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get raob\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/raob/netcdf/\* $public/data/raob/netcdf/");
    chdir "$public/data/raob/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get dropsonde\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/dropsonde/netcdf/\* $public/data/dropsonde/netcdf/");
    chdir "$public/data/dropsonde/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar");


    print "Get pirep\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/pirep/netcdf/\* $public/data/pirep/netcdf/");
    chdir "$public/data/pirep/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get rass\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/profiler/rass/noaanet/netcdf/\* $public/data/profiler/rass/noaanet/netcdf/");
    chdir "$public/data/profiler/rass/noaanet/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get profiler\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/profiler/wind/noaanet/netcdf/\* $public/data/profiler/wind/noaanet/netcdf/");
    chdir "$public/data/profiler/wind/noaanet/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get bl-rass\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/profiler/rass/external/netcdf/\* $public/data/profiler/rass/external/netcdf/");
    chdir "$public/data/profiler/rass/external/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get bl-profiler\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/profiler/wind/external/netcdf/\* $public/data/profiler/wind/external/netcdf/");
    chdir "$public/data/profiler/wind/external/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get acars\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/acars/qc/netcdf/\* $public/data/acars/qc/netcdf/");
    chdir "$public/data/acars/qc/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 

}

if ($opt_m eq "ruc") {
    print "Get ruc\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/grib/ftp_ruc_hyb/7/0/105/236/\* $public/data/grids/ruc/hyb_A236/grib/");
    chdir "$public/data/grids/ruc/hyb_A236/grib/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar");


    if (defined $opt_g) {
        print "Degrib ruc\n";
        if (! -d $opt_g){ die "$opt_g not found! \n";}
        system ("@CSH@ @prefix@/etc/ruc_grib2netcdf.csh $opt_g $public/data/grids/ruc/hyb_A236");
    }

} else {

    print "Get gfs\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/grib/ftp/7/0/96/3/\* $public/data/grids/gfs/grib/");

    if (defined $opt_g) {
        print "Degrib gfs\n";
        if (! -d $opt_g){ die "$opt_g not found! \n";}
        system ("@CSH@ @prefix@/etc/ruc_grib2netcdf.csh $opt_g $public/data/grids/gfs/netcdf");
    }
}	

if ($opt_s eq "8" || $opt_s eq "11" || $opt_s eq "12") {
    my $sat;
    my $satpath;

#   Activate if necessary
    if(length($opt_s) == 1){
        $sat = "0$opt_s";
    }else{
        $sat = "$opt_s";
    }


#   Changing the path based on the choice of satellite!

    if ($opt_s eq "11") {
	$satpath = "fsl-pacus"
    } else {
    	$satpath = "fsl-conus"
    }	
 	


#   Satellite imagery
    print "Get goes$opt_s imager\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/fsl-gs/goes$opt_s\/raw/image/$satpath/netcdf/\* $public/data/sat/fsl-gs/goes$opt_s\/raw/image/$satpath/netcdf/");
    chdir "$public/data/sat/fsl-gs/goes$opt_s\/raw/image/$satpath/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 

    print "Get goes$opt_s imagery (is this used?)\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/nesdis/goes$opt_s\/raw/image/$satpath/netcdf/\* $public/data/grids/sat/nesdis/goes$opt_s\/raw/image/$satpath/netcdf/");
    chdir "$public/data/grids/sat/nesdis/goes$opt_s\/raw/image/$satpath/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


#   Cloud drift winds (OLD)
    print "Get goes$opt_s cloud-drift\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/nesdis/goes$opt_s\/wind/cloud-drift/ascii/\* $public/data/sat/nesdis/goes$opt_s\/wind/cloud-drift/ascii/");
    chdir "$public/data/sat/nesdis/goes$opt_s\/wind/cloud-drift/ascii/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 

    print "Get goes$opt_s vapor-drift\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/nesdis/goes$opt_s\/wind/vapor-drift/ascii/\* $public/data/sat/nesdis/goes$opt_s\/wind/vapor-drift/ascii/");
    chdir "$public/data/sat/nesdis/goes$opt_s\/wind/vapor-drift/ascii/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 

    print "Get goes$opt_s visible cloud drift\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/nesdis/goes$opt_s\/wind/visible/ascii/\* $public/data/sat/nesdis/goes$opt_s\/wind/visible/ascii/");
    chdir "$public/data/sat/nesdis/goes$opt_s\/wind/visible/ascii/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 

    print "Get goes$opt_s sounder$opt_s cloud drift\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/nesdis/goes$opt_s\/wind/sounder$opt_s\/ascii/\* $public/data/sat/nesdis/goes$opt_s\/wind/sounder$opt_s\/ascii/");
    chdir "$public/data/sat/nesdis/goes$opt_s\/wind/sounder$opt_s\/ascii/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 

#   Cloud drift winds (NEW)
    print "Get madis cloud drift winds (3hr)\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/madis/point/HDW/netcdf/\* $public/data/madis/point/HDW/netcdf/");
    chdir "$public/data/madis/point/HDW/netcdf//";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 

    print "Get madis cloud drift winds (1hr)\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/madis/point/HDW1h/netcdf/\* $public/data/madis/point/HDW1h/netcdf/");
    chdir "$public/data/madis/point/HDW1h/netcdf//";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


#   POES Soundings
    print "Get madis POES soundings\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/madis/point/POES/netcdf/\* $public/data/madis/point/POES/netcdf/");
    chdir "$public/data/madis/point/POES/netcdf//";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


#   Data for the LQ3 analysis
    print "Get goes$opt_s tpw\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/nesdis/goes$opt_s\/tpw/sfov_ihop/ascii/\* $public/data/sat/nesdis/goes$opt_s\/tpw/sfov_ihop/ascii/");
    chdir "$public/data/sat/nesdis/goes$opt_s\/tpw/sfov_ihop/ascii/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get goes$opt_s sounding\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/nesdis/goes$opt_s\/sounding/binary/\* $public/data/sat/nesdis/goes$opt_s\/sounding/binary/");
    chdir "$public/data/sat/nesdis/goes$opt_s\/sounding/binary/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


    print "Get goes$opt_s raw-sounder\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/fsl-gs/goes$opt_s\/raw/sounding/scan-area/netcdf/\* $public/data/sat/fsl-gs/goes$opt_s\/raw/sounding/scan-area/netcdf/");
    chdir "$public/data/sat/fsl-gs/goes$opt_s\/raw/sounding/scan-area/netcdf/";
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\.gz\" -exec gunzip {} \\;");
    system ("find -mindepth 1 -maxdepth 1 -name \"\*\.tar\" -exec tar -xvf {} \\;");
    system("rm \*\.tar"); 


}

exit;
