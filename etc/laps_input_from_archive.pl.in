#!@PERL@

# This script pulls raw data needed for LAPS from the MASS store
# You should have a MASS store account to run this

# Options:
#
# -p root data for output "raw" data (analogous to /public)
#
# -t time desired for data (YYYYMMDD)
#
# -m desired model background (e.g. ruc)
#
# -g degrib model background data (supply installroot for the degrib software)
#
# -s desired satellite (use 8 for goes8)
#
# -S skip all standard data download from the MSS

# Require PERL version 5 or newer
require 5;

# Set permissions
umask 002;

# Load packages
use Getopt::Std;
use Time::Local;

# Define command line variables
# opt_t: time (GMT) of LAPS analysis in YYYYMMDD
use vars qw($opt_p $opt_t $opt_m $opt_g $opt_s $opt_S);

getopts('p:t:m:s:g:S');

my $public = $opt_p;
my ($analysis_yr, $analysis_mo, $analysis_dy, );
print "$public\n";
print "$opt_t\n";
if ($opt_t =~ /^(\d\d\d\d)(\d\d)(\d\d)$/) {
 $analysis_yr = $1;
 $analysis_mo = $2;
 $analysis_dy = $3;
}else{
 print "Unrecognized date format. Should be YYYYMMDD. \n";
 exit;
}

if (! defined $opt_S) { 

    print "Get metar\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/metar/netcdf/\* $public/data/metar/netcdf/");

    print "Get madis\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/madis/LDAD/mesonet/netCDF/\* $public/data/madis/LDAD/mesonet/netCDF/");

    print "Get maritime\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/maritime/netcdf/\* $public/data/maritime/netcdf/");

    print "Get wsi-nexrad\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/radar/wsi/nexrad/netcdf/\* $public/data/radar/wsi/nexrad/netcdf/");

    print "Get wsi-nowrad\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/radar/wsi/nowrad/netcdf/\* $public/data/radar/wsi/nowrad/netcdf/");

    print "Get gps\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/gpsmet/netcdf/\* $public/data/gpsmet/netcdf/");

    print "Get radiometer\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/madis/point/radiometer/netcdf/\* $public/data/madis/point/radiometer/netcdf/");

    print "Get fsl-conus\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/fsl-conus/gs/netcdf/\* $public/data/sat/fsl-conus/gs/netcdf/");

    print "Get raob\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/raob/netcdf/\* $public/data/raob/netcdf/");

    print "Get pirep\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/pirep/netcdf/\* $public/data/pirep/netcdf/");

    print "Get rass\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/profiler/rass/noaanet/netcdf/\* $public/data/profiler/rass/noaanet/netcdf/");

    print "Get profiler\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/profiler/wind/noaanet/netcdf/\* $public/data/profiler/wind/noaanet/netcdf/");

    print "Get bl-rass\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/profiler/rass/external/netcdf/\* $public/data/profiler/rass/external/netcdf/");

    print "Get bl-profiler\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/profiler/wind/external/netcdf/\* $public/data/profiler/wind/external/netcdf/");

    print "Get acars\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/acars/qc/netcdf/\* $public/data/acars/qc/netcdf/");
}

if ($opt_m eq "ruc") {
    print "Get ruc\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/grib/ftp_ruc_hyb/7/0/105/236/\* $public/data/grids/ruc/hyb_A236/grib/");

    if (defined $opt_g) {
        print "Degrib ruc\n";
        if (! -d $opt_g){ die "$opt_g not found! \n";}
        system ("@CSH@ @prefix@/etc/ruc_grib2netcdf.csh $opt_g $public/data/grids/ruc/hyb_A236");
    }
}

if ($opt_s eq "8" || $opt_s eq "12") {
    my $sat;

#   Activate if necessary
    if(length($opt_s) == 1){
        $sat = "0$opt_s";
    }else{
        $sat = "$opt_s";
    }

#   Satellite imagery
    print "Get goes$opt_s imagery\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/nesdis/goes$opt_s\/raw/image/fsl-conus/netcdf/\* $public/data/grids/sat/nesdis/goes$opt_s\/raw/image/fsl-conus/netcdf/");

#   Cloud drift winds 
    print "Get goes$opt_s cloud-drift\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/nesdis/goes$opt_s\/wind/cloud-drift/ascii/\* $public/data/sat/nesdis/goes$opt_s\/wind/cloud-drift/ascii/");

#   Data for the LQ3 analysis
    print "Get goes$opt_s tpw\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/nesdis/goes$opt_s\/tpw/sfov_ihop/ascii/\* $public/data/grids/sat/nesdis/goes$opt_s\/tpw/sfov_ihop/ascii/");

    print "Get goes$opt_s sounding\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/nesdis/goes$opt_s\/sounding/binary/\* $public/data/sat/nesdis/goes$opt_s\/sounding/binary/");

    print "Get goes$opt_s raw-sounder\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/fsl-gs/goes$opt_s\/raw/sounding/scan-area/netcdf/\* $public/data/sat/fsl-gs/goes$opt_s\/raw/sounding/scan-area/netcdf/");

    print "Get goes$opt_s imager\n";
    system ("mssGet --verbose /mss/fdr/$analysis_yr/$analysis_mo/$analysis_dy/data/sat/fsl-gs/goes$opt_s\/raw/image/fsl-conus/netcdf/\* $public/data/sat/fsl-gs/goes$opt_s\/raw/image/fsl-conus/netcdf/");

}

exit;
